"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * Generate Command
 */
const objectHelper_1 = require("unitejs-framework/dist/helpers/objectHelper");
const parameterValidation_1 = require("unitejs-framework/dist/helpers/parameterValidation");
const engineCommandBase_1 = require("../engine/engineCommandBase");
const engineVariables_1 = require("../engine/engineVariables");
const templateHelper_1 = require("../helpers/templateHelper");
class GenerateCommand extends engineCommandBase_1.EngineCommandBase {
    run(args) {
        const _super = name => super[name];
        return __awaiter(this, void 0, void 0, function* () {
            const uniteConfiguration = yield this.loadConfiguration(args.outputDirectory, undefined, undefined, false);
            if (!uniteConfiguration) {
                this._logger.error("There is no unite.json to use for configuration.");
                return 1;
            }
            if (!parameterValidation_1.ParameterValidation.notEmpty(this._logger, "name", args.name)) {
                return 1;
            }
            if (!parameterValidation_1.ParameterValidation.notEmpty(this._logger, "type", args.type)) {
                return 1;
            }
            this._logger.info("");
            try {
                const engineVariables = new engineVariables_1.EngineVariables();
                _super("createEngineVariables").call(this, args.outputDirectory, uniteConfiguration, engineVariables);
                const generateTemplatesFolder = this._fileSystem.pathCombine(this._engineAssetsFolder, `appFramework/${uniteConfiguration.applicationFramework.toLowerCase()}/generate/`);
                const exists = yield this._fileSystem.fileExists(generateTemplatesFolder, "generate-templates.json");
                if (exists) {
                    const generateTemplates = yield this._fileSystem.fileReadJson(generateTemplatesFolder, "generate-templates.json");
                    const keys = Object.keys(generateTemplates);
                    const typeLower = args.type.toLowerCase();
                    const templateKey = keys.find(k => k.toLowerCase() === typeLower);
                    if (templateKey) {
                        let template = generateTemplates[templateKey];
                        const sharedGenerateTemplatesFolder = this._fileSystem.pathCombine(this._engineAssetsFolder, `appFramework/shared/generate/`);
                        if (generateTemplates[templateKey].isShared) {
                            const sharedExists = yield this._fileSystem.fileExists(sharedGenerateTemplatesFolder, "generate-templates.json");
                            if (sharedExists) {
                                const sharedGenerateTemplates = yield this._fileSystem.fileReadJson(sharedGenerateTemplatesFolder, "generate-templates.json");
                                if (sharedGenerateTemplates[templateKey]) {
                                    template = objectHelper_1.ObjectHelper.merge(template, sharedGenerateTemplates[templateKey]);
                                }
                                else {
                                    this._logger.error(`Can not find a type of '${args.type}' in the shared templates'`);
                                    return 1;
                                }
                            }
                            else {
                                this._logger.error(`There are no shared generate-templates and shared template '${args.type}' is required`);
                                return 1;
                            }
                        }
                        // need this for synthetic import flags
                        this._pipeline.add("moduleType", "CommonJS");
                        this._pipeline.add("moduleType", "SystemJS");
                        this._pipeline.add("moduleType", "AMD");
                        let ret = yield this._pipeline.run(uniteConfiguration, engineVariables, ["initialise"], false);
                        if (ret === 0) {
                            ret = yield this.generateFromTemplate(args, uniteConfiguration, engineVariables, generateTemplates[templateKey].isShared ? sharedGenerateTemplatesFolder : generateTemplatesFolder, template);
                        }
                        return ret;
                    }
                    else {
                        this._logger.error(`Can not find a type of '${args.type}' for applicationFramework '${uniteConfiguration.applicationFramework}, possible values are [${keys.join(", ")}]'`);
                        return 1;
                    }
                }
                else {
                    this._logger.error(`There are no generate-templates for applicationFramework '${uniteConfiguration.applicationFramework}'`);
                    return 1;
                }
            }
            catch (err) {
                this._logger.error(`There was an error loading generate-templates for applicationFramework '${uniteConfiguration.applicationFramework}'`, err);
                return 1;
            }
        });
    }
    generateFromTemplate(args, uniteConfiguration, engineVariables, generateTemplatesFolder, generateTemplate) {
        return __awaiter(this, void 0, void 0, function* () {
            const substitutions = Object.assign(templateHelper_1.TemplateHelper.generateSubstitutions(args.name), templateHelper_1.TemplateHelper.createCodeSubstitutions(engineVariables));
            // See where we are in relation to the www folder
            const baseDirectory = this._fileSystem.pathAbsolute("./");
            const wwwFolder = this._fileSystem.pathAbsolute(this._fileSystem.pathCombine(args.outputDirectory, uniteConfiguration.dirs.wwwRoot));
            const srcFolder = this._fileSystem.pathAbsolute(this._fileSystem.pathCombine(wwwFolder, uniteConfiguration.dirs.www.src));
            // If we are somewhere in the srcFolder use that as a starting point, otherwise just use src root
            const startSrcFolder = baseDirectory.startsWith(srcFolder) ? baseDirectory : srcFolder;
            // Calculate any subFolder based on arg or default with substitutions
            const subFolder = args.subFolder !== undefined && args.subFolder !== null ? args.subFolder :
                generateTemplate.defaultFolder !== undefined && generateTemplate.defaultFolder !== null ? templateHelper_1.TemplateHelper.replaceSubstitutions(substitutions, generateTemplate.defaultFolder) : "";
            // Now combine the output folder
            const srcOutputFolder = this._fileSystem.pathCombine(startSrcFolder, subFolder);
            // Find the relativee from srcFolder to srcOutputFolder so we can combine for other folder structures
            const srcRelative = this._fileSystem.pathFileRelative(srcFolder, srcOutputFolder);
            let ret = yield this.copyFiles(generateTemplatesFolder, generateTemplate.sourceFiles, srcOutputFolder, `${args.type}/src`, uniteConfiguration.sourceExtensions, substitutions);
            if (ret === 0) {
                ret = yield this.copyFiles(generateTemplatesFolder, generateTemplate.viewFiles, srcOutputFolder, `${args.type}/view`, uniteConfiguration.viewExtensions, substitutions);
            }
            if (ret === 0) {
                ret = yield this.copyFiles(generateTemplatesFolder, generateTemplate.styleFiles, srcOutputFolder, `${args.type}/style`, [uniteConfiguration.styleExtension], substitutions);
            }
            if (ret === 0 && uniteConfiguration.unitTestRunner !== "None") {
                const unitSrcFolder = this._fileSystem.pathAbsolute(this._fileSystem.pathCombine(wwwFolder, uniteConfiguration.dirs.www.unitTestSrc));
                const unitSrcOutputFolder = this._fileSystem.pathCombine(unitSrcFolder, srcRelative);
                substitutions[`../../src/`] = this._fileSystem.pathToWeb(this._fileSystem.pathDirectoryRelative(unitSrcOutputFolder, srcOutputFolder))
                    .replace(/^\.\//, "");
                ret = yield this.copyFiles(generateTemplatesFolder, generateTemplate.unitTestFiles, unitSrcOutputFolder, `${args.type}/unit/${uniteConfiguration.unitTestFramework.toLowerCase()}`, uniteConfiguration.sourceExtensions, substitutions);
            }
            if (ret === 0 && uniteConfiguration.e2eTestRunner !== "None") {
                const e2eSrcFolder = this._fileSystem.pathAbsolute(this._fileSystem.pathCombine(wwwFolder, uniteConfiguration.dirs.www.e2eTestSrc));
                const e2eSrcOutputFolder = this._fileSystem.pathCombine(e2eSrcFolder, srcRelative);
                substitutions[`../../src`] = this._fileSystem.pathToWeb(this._fileSystem.pathDirectoryRelative(e2eSrcOutputFolder, srcOutputFolder))
                    .replace(/^\.\//, "");
                ret = yield this.copyFiles(generateTemplatesFolder, generateTemplate.e2eTestFiles, e2eSrcOutputFolder, `${args.type}/e2e/${uniteConfiguration.unitTestFramework.toLowerCase()}`, uniteConfiguration.sourceExtensions, substitutions);
            }
            if (ret === 0) {
                this.displayCompletionMessage(engineVariables, false);
            }
            return ret;
        });
    }
    copyFiles(generateTemplatesFolder, filenames, destFolder, templateSubFolder, possibleExtensions, substitutions) {
        return __awaiter(this, void 0, void 0, function* () {
            if (filenames && filenames.length > 0) {
                const srcFolder = this._fileSystem.pathCombine(generateTemplatesFolder, templateSubFolder);
                for (let i = 0; i < filenames.length; i++) {
                    const srcFilename = filenames[i];
                    let doneCopy = false;
                    for (let j = 0; j < possibleExtensions.length && !doneCopy; j++) {
                        const srcFilename2 = `${srcFilename}.${possibleExtensions[j]}`;
                        const destFilename = `${templateHelper_1.TemplateHelper.replaceSubstitutions(substitutions, srcFilename)}.${possibleExtensions[j]}`;
                        try {
                            const destExists = yield this._fileSystem.fileExists(destFolder, destFilename);
                            if (destExists) {
                                this._logger.error(`Destination file exists, aborting`, undefined, { srcFolder, srcFilename2, destFolder, destFilename });
                                return 1;
                            }
                            else {
                                const exists = yield this._fileSystem.fileExists(srcFolder, srcFilename2);
                                if (exists) {
                                    let content = yield this._fileSystem.fileReadText(srcFolder, srcFilename2);
                                    if (content.startsWith("!")) {
                                        this._logger.error(content.substr(1));
                                        return 1;
                                    }
                                    else {
                                        content = templateHelper_1.TemplateHelper.replaceSubstitutions(substitutions, content);
                                        yield this._fileSystem.directoryCreate(destFolder);
                                        this._logger.info(`Writing ${this._fileSystem.pathCombine(destFolder, destFilename)}`);
                                        yield this._fileSystem.fileWriteText(destFolder, destFilename, content);
                                        doneCopy = true;
                                    }
                                }
                            }
                        }
                        catch (err) {
                            this._logger.error(`There was an generating from the template`, err, { srcFolder, srcFilename2, destFolder, destFilename });
                            return 1;
                        }
                    }
                    if (!doneCopy) {
                        this._logger.error(`Can not find a source for '${srcFilename}' with the possible extensions [${possibleExtensions.join(", ")}]`);
                        return 1;
                    }
                }
            }
            return 0;
        });
    }
}
exports.GenerateCommand = GenerateCommand;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb21tYW5kcy9nZW5lcmF0ZUNvbW1hbmQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQUFBOztHQUVHO0FBQ0gsOEVBQTJFO0FBQzNFLDRGQUF5RjtBQUl6RixtRUFBZ0U7QUFDaEUsK0RBQTREO0FBQzVELDhEQUEyRDtBQUkzRCxxQkFBNkIsU0FBUSxxQ0FBaUI7SUFDckMsR0FBRyxDQUFDLElBQTRCOzs7WUFDekMsTUFBTSxrQkFBa0IsR0FBRyxNQUFNLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsZUFBZSxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFFM0csSUFBSSxDQUFDLGtCQUFrQixFQUFFO2dCQUNyQixJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxrREFBa0QsQ0FBQyxDQUFDO2dCQUN2RSxPQUFPLENBQUMsQ0FBQzthQUNaO1lBRUQsSUFBSSxDQUFDLHlDQUFtQixDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUU7Z0JBQ2hFLE9BQU8sQ0FBQyxDQUFDO2FBQ1o7WUFFRCxJQUFJLENBQUMseUNBQW1CLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRTtnQkFDaEUsT0FBTyxDQUFDLENBQUM7YUFDWjtZQUVELElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBRXRCLElBQUk7Z0JBQ0EsTUFBTSxlQUFlLEdBQUcsSUFBSSxpQ0FBZSxFQUFFLENBQUM7Z0JBQzlDLCtCQUEyQixZQUFDLElBQUksQ0FBQyxlQUFlLEVBQUUsa0JBQWtCLEVBQUUsZUFBZSxFQUFFO2dCQUV2RixNQUFNLHVCQUF1QixHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLElBQUksQ0FB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LENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyw4QkFBOEIsV0FBVyxtQ0FBbUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQzt3QkFDakksT0FBTyxDQUFDLENBQUM7cUJBQ1o7aUJBQ0o7YUFDSjtZQUVELE9BQU8sQ0FBQyxDQUFDO1FBQ2IsQ0FBQztLQUFBO0NBQ0o7QUF6T0QsMENBeU9DIiwiZmlsZSI6ImNvbW1hbmRzL2dlbmVyYXRlQ29tbWFuZC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogR2VuZXJhdGUgQ29tbWFuZFxuICovXG5pbXBvcnQgeyBPYmplY3RIZWxwZXIgfSBmcm9tIFwidW5pdGVqcy1mcmFtZXdvcmsvZGlzdC9oZWxwZXJzL29iamVjdEhlbHBlclwiO1xuaW1wb3J0IHsgUGFyYW1ldGVyVmFsaWRhdGlvbiB9IGZyb20gXCJ1bml0ZWpzLWZyYW1ld29yay9kaXN0L2hlbHBlcnMvcGFyYW1ldGVyVmFsaWRhdGlvblwiO1xuaW1wb3J0IHsgSVVuaXRlR2VuZXJhdGVUZW1wbGF0ZSB9IGZyb20gXCIuLi9jb25maWd1cmF0aW9uL21vZGVscy91bml0ZS9JVW5pdGVHZW5lcmF0ZVRlbXBsYXRlXCI7XG5pbXBvcnQgeyBJVW5pdGVHZW5lcmF0ZVRlbXBsYXRlcyB9IGZyb20gXCIuLi9jb25maWd1cmF0aW9uL21vZGVscy91bml0ZS9JVW5pdGVHZW5lcmF0ZVRlbXBsYXRlc1wiO1xuaW1wb3J0IHsgVW5pdGVDb25maWd1cmF0aW9uIH0gZnJvbSBcIi4uL2NvbmZpZ3VyYXRpb24vbW9kZWxzL3VuaXRlL3VuaXRlQ29uZmlndXJhdGlvblwiO1xuaW1wb3J0IHsgRW5naW5lQ29tbWFuZEJhc2UgfSBmcm9tIFwiLi4vZW5naW5lL2VuZ2luZUNvbW1hbmRCYXNlXCI7XG5pbXBvcnQgeyBFbmdpbmVWYXJpYWJsZXMgfSBmcm9tIFwiLi4vZW5naW5lL2VuZ2luZVZhcmlhYmxlc1wiO1xuaW1wb3J0IHsgVGVtcGxhdGVIZWxwZXIgfSBmcm9tIFwiLi4vaGVscGVycy90ZW1wbGF0ZUhlbHBlclwiO1xuaW1wb3J0IHsgSUVuZ2luZUNvbW1hbmQgfSBmcm9tIFwiLi4vaW50ZXJmYWNlcy9JRW5naW5lQ29tbWFuZFwiO1xuaW1wb3J0IHsgSUdlbmVyYXRlQ29tbWFuZFBhcmFtcyB9IGZyb20gXCIuLi9pbnRlcmZhY2VzL0lHZW5lcmF0ZUNvbW1hbmRQYXJhbXNcIjtcblxuZXhwb3J0IGNsYXNzIEdlbmVyYXRlQ29tbWFuZCBleHRlbmRzIEVuZ2luZUNvbW1hbmRCYXNlIGltcGxlbWVudHMgSUVuZ2luZUNvbW1hbmQ8SUdlbmVyYXRlQ29tbWFuZFBhcmFtcz4ge1xuICAgIHB1YmxpYyBhc3luYyBydW4oYXJnczogSUdlbmVyYXRlQ29tbWFuZFBhcmFtcyk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgICAgIGNvbnN0IHVuaXRlQ29uZmlndXJhdGlvbiA9IGF3YWl0IHRoaXMubG9hZENvbmZpZ3VyYXRpb24oYXJncy5vdXRwdXREaXJlY3RvcnksIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBmYWxzZSk7XG5cbiAgICAgICAgaWYgKCF1bml0ZUNvbmZpZ3VyYXRpb24pIHtcbiAgICAgICAgICAgIHRoaXMuX2xvZ2dlci5lcnJvcihcIlRoZXJlIGlzIG5vIHVuaXRlLmpzb24gdG8gdXNlIGZvciBjb25maWd1cmF0aW9uLlwiKTtcbiAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFQYXJhbWV0ZXJWYWxpZGF0aW9uLm5vdEVtcHR5KHRoaXMuX2xvZ2dlciwgXCJuYW1lXCIsIGFyZ3MubmFtZSkpIHtcbiAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFQYXJhbWV0ZXJWYWxpZGF0aW9uLm5vdEVtcHR5KHRoaXMuX2xvZ2dlciwgXCJ0eXBlXCIsIGFyZ3MudHlwZSkpIHtcbiAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5fbG9nZ2VyLmluZm8oXCJcIik7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IGVuZ2luZVZhcmlhYmxlcyA9IG5ldyBFbmdpbmVWYXJpYWJsZXMoKTtcbiAgICAgICAgICAgIHN1cGVyLmNyZWF0ZUVuZ2luZVZhcmlhYmxlcyhhcmdzLm91dHB1dERpcmVjdG9yeSwgdW5pdGVDb25maWd1cmF0aW9uLCBlbmdpbmVWYXJpYWJsZXMpO1xuXG4gICAgICAgICAgICBjb25zdCBnZW5lcmF0ZVRlbXBsYXRlc0ZvbGRlciA9IHRoaXMuX2ZpbGVTeXN0ZW0ucGF0aENvbWJpbmUodGhpcy5fZW5naW5lQXNzZXRzRm9sZGVyLCBgYXBwRnJhbWV3b3JrLyR7dW5pdGVDb25maWd1cmF0aW9uLmFwcGxpY2F0aW9uRnJhbWV3b3JrLnRvTG93ZXJDYXNlKCl9L2dlbmVyYXRlL2ApO1xuXG4gICAgICAgICAgICBjb25zdCBleGlzdHMgPSBhd2FpdCB0aGlzLl9maWxlU3lzdGVtLmZpbGVFeGlzdHMoZ2VuZXJhdGVUZW1wbGF0ZXNGb2xkZXIsIFwiZ2VuZXJhdGUtdGVtcGxhdGVzLmpzb25cIik7XG5cbiAgICAgICAgICAgIGlmIChleGlzdHMpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBnZW5lcmF0ZVRlbXBsYXRlcyA9IGF3YWl0IHRoaXMuX2ZpbGVTeXN0ZW0uZmlsZVJlYWRKc29uPElVbml0ZUdlbmVyYXRlVGVtcGxhdGVzPihnZW5lcmF0ZVRlbXBsYXRlc0ZvbGRlciwgXCJnZW5lcmF0ZS10ZW1wbGF0ZXMuanNvblwiKTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhnZW5lcmF0ZVRlbXBsYXRlcyk7XG5cbiAgICAgICAgICAgICAgICBjb25zdCB0eXBlTG93ZXIgPSBhcmdzLnR5cGUudG9Mb3dlckNhc2UoKTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IHRlbXBsYXRlS2V5ID0ga2V5cy5maW5kKGsgPT4gay50b0xvd2VyQ2FzZSgpID09PSB0eXBlTG93ZXIpO1xuXG4gICAgICAgICAgICAgICAgaWYgKHRlbXBsYXRlS2V5KSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCB0ZW1wbGF0ZSA9IGdlbmVyYXRlVGVtcGxhdGVzW3RlbXBsYXRlS2V5XTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2hhcmVkR2VuZXJhdGVUZW1wbGF0ZXNGb2xkZXIgPSB0aGlzLl9maWxlU3lzdGVtLnBhdGhDb21iaW5lKHRoaXMuX2VuZ2luZUFzc2V0c0ZvbGRlciwgYGFwcEZyYW1ld29yay9zaGFyZWQvZ2VuZXJhdGUvYCk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChnZW5lcmF0ZVRlbXBsYXRlc1t0ZW1wbGF0ZUtleV0uaXNTaGFyZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNoYXJlZEV4aXN0cyA9IGF3YWl0IHRoaXMuX2ZpbGVTeXN0ZW0uZmlsZUV4aXN0cyhzaGFyZWRHZW5lcmF0ZVRlbXBsYXRlc0ZvbGRlciwgXCJnZW5lcmF0ZS10ZW1wbGF0ZXMuanNvblwiKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNoYXJlZEV4aXN0cykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNoYXJlZEdlbmVyYXRlVGVtcGxhdGVzID0gYXdhaXQgdGhpcy5fZmlsZVN5c3RlbS5maWxlUmVhZEpzb248SVVuaXRlR2VuZXJhdGVUZW1wbGF0ZXM+KHNoYXJlZEdlbmVyYXRlVGVtcGxhdGVzRm9sZGVyLCBcImdlbmVyYXRlLXRlbXBsYXRlcy5qc29uXCIpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNoYXJlZEdlbmVyYXRlVGVtcGxhdGVzW3RlbXBsYXRlS2V5XSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZSA9IE9iamVjdEhlbHBlci5tZXJnZSh0ZW1wbGF0ZSwgc2hhcmVkR2VuZXJhdGVUZW1wbGF0ZXNbdGVtcGxhdGVLZXldKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9sb2dnZXIuZXJyb3IoYENhbiBub3QgZmluZCBhIHR5cGUgb2YgJyR7YXJncy50eXBlfScgaW4gdGhlIHNoYXJlZCB0ZW1wbGF0ZXMnYCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fbG9nZ2VyLmVycm9yKGBUaGVyZSBhcmUgbm8gc2hhcmVkIGdlbmVyYXRlLXRlbXBsYXRlcyBhbmQgc2hhcmVkIHRlbXBsYXRlICcke2FyZ3MudHlwZX0nIGlzIHJlcXVpcmVkYCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDE7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAvLyBuZWVkIHRoaXMgZm9yIHN5bnRoZXRpYyBpbXBvcnQgZmxhZ3NcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGlwZWxpbmUuYWRkKFwibW9kdWxlVHlwZVwiLCBcIkNvbW1vbkpTXCIpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9waXBlbGluZS5hZGQoXCJtb2R1bGVUeXBlXCIsIFwiU3lzdGVtSlNcIik7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3BpcGVsaW5lLmFkZChcIm1vZHVsZVR5cGVcIiwgXCJBTURcIik7XG5cbiAgICAgICAgICAgICAgICAgICAgbGV0IHJldCA9IGF3YWl0IHRoaXMuX3BpcGVsaW5lLnJ1bih1bml0ZUNvbmZpZ3VyYXRpb24sIGVuZ2luZVZhcmlhYmxlcywgW1wiaW5pdGlhbGlzZVwiXSwgZmFsc2UpO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChyZXQgPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldCA9IGF3YWl0IHRoaXMuZ2VuZXJhdGVGcm9tVGVtcGxhdGUoYXJncyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdW5pdGVDb25maWd1cmF0aW9uLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVWYXJpYWJsZXMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdlbmVyYXRlVGVtcGxhdGVzW3RlbXBsYXRlS2V5XS5pc1NoYXJlZCA/IHNoYXJlZEdlbmVyYXRlVGVtcGxhdGVzRm9sZGVyIDogZ2VuZXJhdGVUZW1wbGF0ZXNGb2xkZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXQ7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fbG9nZ2VyLmVycm9yKGBDYW4gbm90IGZpbmQgYSB0eXBlIG9mICcke2FyZ3MudHlwZX0nIGZvciBhcHBsaWNhdGlvbkZyYW1ld29yayAnJHt1bml0ZUNvbmZpZ3VyYXRpb24uYXBwbGljYXRpb25GcmFtZXdvcmt9LCBwb3NzaWJsZSB2YWx1ZXMgYXJlIFske2tleXMuam9pbihcIiwgXCIpfV0nYCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fbG9nZ2VyLmVycm9yKGBUaGVyZSBhcmUgbm8gZ2VuZXJhdGUtdGVtcGxhdGVzIGZvciBhcHBsaWNhdGlvbkZyYW1ld29yayAnJHt1bml0ZUNvbmZpZ3VyYXRpb24uYXBwbGljYXRpb25GcmFtZXdvcmt9J2ApO1xuICAgICAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIHRoaXMuX2xvZ2dlci5lcnJvcihgVGhlcmUgd2FzIGFuIGVycm9yIGxvYWRpbmcgZ2VuZXJhdGUtdGVtcGxhdGVzIGZvciBhcHBsaWNhdGlvbkZyYW1ld29yayAnJHt1bml0ZUNvbmZpZ3VyYXRpb24uYXBwbGljYXRpb25GcmFtZXdvcmt9J2AsIGVycik7XG4gICAgICAgICAgICByZXR1cm4gMTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgZ2VuZXJhdGVGcm9tVGVtcGxhdGUoYXJnczogSUdlbmVyYXRlQ29tbWFuZFBhcmFtcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVuaXRlQ29uZmlndXJhdGlvbjogVW5pdGVDb25maWd1cmF0aW9uLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lVmFyaWFibGVzOiBFbmdpbmVWYXJpYWJsZXMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnZW5lcmF0ZVRlbXBsYXRlc0ZvbGRlcjogc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2VuZXJhdGVUZW1wbGF0ZTogSVVuaXRlR2VuZXJhdGVUZW1wbGF0ZSk6IFByb21pc2U8bnVtYmVyPiB7XG5cbiAgICAgICAgY29uc3Qgc3Vic3RpdHV0aW9uczogeyBbaWQ6IHN0cmluZ106IHN0cmluZyB9ID1cbiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oVGVtcGxhdGVIZWxwZXIuZ2VuZXJhdGVTdWJzdGl0dXRpb25zKGFyZ3MubmFtZSksIFRlbXBsYXRlSGVscGVyLmNyZWF0ZUNvZGVTdWJzdGl0dXRpb25zKGVuZ2luZVZhcmlhYmxlcykpO1xuXG4gICAgICAgIC8vIFNlZSB3aGVyZSB3ZSBhcmUgaW4gcmVsYXRpb24gdG8gdGhlIHd3dyBmb2xkZXJcbiAgICAgICAgY29uc3QgYmFzZURpcmVjdG9yeSA9IHRoaXMuX2ZpbGVTeXN0ZW0ucGF0aEFic29sdXRlKFwiLi9cIik7XG4gICAgICAgIGNvbnN0IHd3d0ZvbGRlciA9IHRoaXMuX2ZpbGVTeXN0ZW0ucGF0aEFic29sdXRlKHRoaXMuX2ZpbGVTeXN0ZW0ucGF0aENvbWJpbmUoYXJncy5vdXRwdXREaXJlY3RvcnksIHVuaXRlQ29uZmlndXJhdGlvbi5kaXJzLnd3d1Jvb3QpKTtcbiAgICAgICAgY29uc3Qgc3JjRm9sZGVyID0gdGhpcy5fZmlsZVN5c3RlbS5wYXRoQWJzb2x1dGUodGhpcy5fZmlsZVN5c3RlbS5wYXRoQ29tYmluZSh3d3dGb2xkZXIsIHVuaXRlQ29uZmlndXJhdGlvbi5kaXJzLnd3dy5zcmMpKTtcblxuICAgICAgICAvLyBJZiB3ZSBhcmUgc29tZXdoZXJlIGluIHRoZSBzcmNGb2xkZXIgdXNlIHRoYXQgYXMgYSBzdGFydGluZyBwb2ludCwgb3RoZXJ3aXNlIGp1c3QgdXNlIHNyYyByb290XG4gICAgICAgIGNvbnN0IHN0YXJ0U3JjRm9sZGVyID0gYmFzZURpcmVjdG9yeS5zdGFydHNXaXRoKHNyY0ZvbGRlcikgPyBiYXNlRGlyZWN0b3J5IDogc3JjRm9sZGVyO1xuXG4gICAgICAgIC8vIENhbGN1bGF0ZSBhbnkgc3ViRm9sZGVyIGJhc2VkIG9uIGFyZyBvciBkZWZhdWx0IHdpdGggc3Vic3RpdHV0aW9uc1xuICAgICAgICBjb25zdCBzdWJGb2xkZXIgPSBhcmdzLnN1YkZvbGRlciAhPT0gdW5kZWZpbmVkICYmIGFyZ3Muc3ViRm9sZGVyICE9PSBudWxsID8gYXJncy5zdWJGb2xkZXIgOlxuICAgICAgICAgICAgZ2VuZXJhdGVUZW1wbGF0ZS5kZWZhdWx0Rm9sZGVyICE9PSB1bmRlZmluZWQgJiYgZ2VuZXJhdGVUZW1wbGF0ZS5kZWZhdWx0Rm9sZGVyICE9PSBudWxsID8gVGVtcGxhdGVIZWxwZXIucmVwbGFjZVN1YnN0aXR1dGlvbnMoc3Vic3RpdHV0aW9ucywgZ2VuZXJhdGVUZW1wbGF0ZS5kZWZhdWx0Rm9sZGVyKSA6IFwiXCI7XG5cbiAgICAgICAgLy8gTm93IGNvbWJpbmUgdGhlIG91dHB1dCBmb2xkZXJcbiAgICAgICAgY29uc3Qgc3JjT3V0cHV0Rm9sZGVyID0gdGhpcy5fZmlsZVN5c3RlbS5wYXRoQ29tYmluZShzdGFydFNyY0ZvbGRlciwgc3ViRm9sZGVyKTtcblxuICAgICAgICAvLyBGaW5kIHRoZSByZWxhdGl2ZWUgZnJvbSBzcmNGb2xkZXIgdG8gc3JjT3V0cHV0Rm9sZGVyIHNvIHdlIGNhbiBjb21iaW5lIGZvciBvdGhlciBmb2xkZXIgc3RydWN0dXJlc1xuICAgICAgICBjb25zdCBzcmNSZWxhdGl2ZSA9IHRoaXMuX2ZpbGVTeXN0ZW0ucGF0aEZpbGVSZWxhdGl2ZShzcmNGb2xkZXIsIHNyY091dHB1dEZvbGRlcik7XG5cbiAgICAgICAgbGV0IHJldCA9IGF3YWl0IHRoaXMuY29weUZpbGVzKGdlbmVyYXRlVGVtcGxhdGVzRm9sZGVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2VuZXJhdGVUZW1wbGF0ZS5zb3VyY2VGaWxlcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNyY091dHB1dEZvbGRlcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGAke2FyZ3MudHlwZX0vc3JjYCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVuaXRlQ29uZmlndXJhdGlvbi5zb3VyY2VFeHRlbnNpb25zLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3Vic3RpdHV0aW9ucyk7XG5cbiAgICAgICAgaWYgKHJldCA9PT0gMCkge1xuICAgICAgICAgICAgcmV0ID0gYXdhaXQgdGhpcy5jb3B5RmlsZXMoZ2VuZXJhdGVUZW1wbGF0ZXNGb2xkZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnZW5lcmF0ZVRlbXBsYXRlLnZpZXdGaWxlcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNyY091dHB1dEZvbGRlcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGAke2FyZ3MudHlwZX0vdmlld2AsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1bml0ZUNvbmZpZ3VyYXRpb24udmlld0V4dGVuc2lvbnMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWJzdGl0dXRpb25zKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChyZXQgPT09IDApIHtcbiAgICAgICAgICAgIHJldCA9IGF3YWl0IHRoaXMuY29weUZpbGVzKGdlbmVyYXRlVGVtcGxhdGVzRm9sZGVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2VuZXJhdGVUZW1wbGF0ZS5zdHlsZUZpbGVzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3JjT3V0cHV0Rm9sZGVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYCR7YXJncy50eXBlfS9zdHlsZWAsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBbdW5pdGVDb25maWd1cmF0aW9uLnN0eWxlRXh0ZW5zaW9uXSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1YnN0aXR1dGlvbnMpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHJldCA9PT0gMCAmJiB1bml0ZUNvbmZpZ3VyYXRpb24udW5pdFRlc3RSdW5uZXIgIT09IFwiTm9uZVwiKSB7XG4gICAgICAgICAgICBjb25zdCB1bml0U3JjRm9sZGVyID0gdGhpcy5fZmlsZVN5c3RlbS5wYXRoQWJzb2x1dGUodGhpcy5fZmlsZVN5c3RlbS5wYXRoQ29tYmluZSh3d3dGb2xkZXIsIHVuaXRlQ29uZmlndXJhdGlvbi5kaXJzLnd3dy51bml0VGVzdFNyYykpO1xuICAgICAgICAgICAgY29uc3QgdW5pdFNyY091dHB1dEZvbGRlciA9IHRoaXMuX2ZpbGVTeXN0ZW0ucGF0aENvbWJpbmUodW5pdFNyY0ZvbGRlciwgc3JjUmVsYXRpdmUpO1xuICAgICAgICAgICAgc3Vic3RpdHV0aW9uc1tgLi4vLi4vc3JjL2BdID0gdGhpcy5fZmlsZVN5c3RlbS5wYXRoVG9XZWIodGhpcy5fZmlsZVN5c3RlbS5wYXRoRGlyZWN0b3J5UmVsYXRpdmUodW5pdFNyY091dHB1dEZvbGRlciwgc3JjT3V0cHV0Rm9sZGVyKSlcbiAgICAgICAgICAgICAgICAucmVwbGFjZSgvXlxcLlxcLy8sIFwiXCIpO1xuXG4gICAgICAgICAgICByZXQgPSBhd2FpdCB0aGlzLmNvcHlGaWxlcyhnZW5lcmF0ZVRlbXBsYXRlc0ZvbGRlcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdlbmVyYXRlVGVtcGxhdGUudW5pdFRlc3RGaWxlcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVuaXRTcmNPdXRwdXRGb2xkZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgJHthcmdzLnR5cGV9L3VuaXQvJHt1bml0ZUNvbmZpZ3VyYXRpb24udW5pdFRlc3RGcmFtZXdvcmsudG9Mb3dlckNhc2UoKX1gLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdW5pdGVDb25maWd1cmF0aW9uLnNvdXJjZUV4dGVuc2lvbnMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWJzdGl0dXRpb25zKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChyZXQgPT09IDAgJiYgdW5pdGVDb25maWd1cmF0aW9uLmUyZVRlc3RSdW5uZXIgIT09IFwiTm9uZVwiKSB7XG4gICAgICAgICAgICBjb25zdCBlMmVTcmNGb2xkZXIgPSB0aGlzLl9maWxlU3lzdGVtLnBhdGhBYnNvbHV0ZSh0aGlzLl9maWxlU3lzdGVtLnBhdGhDb21iaW5lKHd3d0ZvbGRlciwgdW5pdGVDb25maWd1cmF0aW9uLmRpcnMud3d3LmUyZVRlc3RTcmMpKTtcbiAgICAgICAgICAgIGNvbnN0IGUyZVNyY091dHB1dEZvbGRlciA9IHRoaXMuX2ZpbGVTeXN0ZW0ucGF0aENvbWJpbmUoZTJlU3JjRm9sZGVyLCBzcmNSZWxhdGl2ZSk7XG4gICAgICAgICAgICBzdWJzdGl0dXRpb25zW2AuLi8uLi9zcmNgXSA9IHRoaXMuX2ZpbGVTeXN0ZW0ucGF0aFRvV2ViKHRoaXMuX2ZpbGVTeXN0ZW0ucGF0aERpcmVjdG9yeVJlbGF0aXZlKGUyZVNyY091dHB1dEZvbGRlciwgc3JjT3V0cHV0Rm9sZGVyKSlcbiAgICAgICAgICAgICAgICAucmVwbGFjZSgvXlxcLlxcLy8sIFwiXCIpO1xuXG4gICAgICAgICAgICByZXQgPSBhd2FpdCB0aGlzLmNvcHlGaWxlcyhnZW5lcmF0ZVRlbXBsYXRlc0ZvbGRlcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdlbmVyYXRlVGVtcGxhdGUuZTJlVGVzdEZpbGVzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZTJlU3JjT3V0cHV0Rm9sZGVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYCR7YXJncy50eXBlfS9lMmUvJHt1bml0ZUNvbmZpZ3VyYXRpb24udW5pdFRlc3RGcmFtZXdvcmsudG9Mb3dlckNhc2UoKX1gLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdW5pdGVDb25maWd1cmF0aW9uLnNvdXJjZUV4dGVuc2lvbnMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWJzdGl0dXRpb25zKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChyZXQgPT09IDApIHtcbiAgICAgICAgICAgIHRoaXMuZGlzcGxheUNvbXBsZXRpb25NZXNzYWdlKGVuZ2luZVZhcmlhYmxlcywgZmFsc2UpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJldDtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIGNvcHlGaWxlcyhnZW5lcmF0ZVRlbXBsYXRlc0ZvbGRlcjogc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVuYW1lczogc3RyaW5nW10sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzdEZvbGRlcjogc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlU3ViRm9sZGVyOiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zc2libGVFeHRlbnNpb25zOiBzdHJpbmdbXSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWJzdGl0dXRpb25zOiB7IFtpZDogc3RyaW5nXTogc3RyaW5nIH0pOiBQcm9taXNlPG51bWJlcj4ge1xuICAgICAgICBpZiAoZmlsZW5hbWVzICYmIGZpbGVuYW1lcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBjb25zdCBzcmNGb2xkZXIgPSB0aGlzLl9maWxlU3lzdGVtLnBhdGhDb21iaW5lKGdlbmVyYXRlVGVtcGxhdGVzRm9sZGVyLCB0ZW1wbGF0ZVN1YkZvbGRlcik7XG5cbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZmlsZW5hbWVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgc3JjRmlsZW5hbWUgPSBmaWxlbmFtZXNbaV07XG5cbiAgICAgICAgICAgICAgICBsZXQgZG9uZUNvcHkgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHBvc3NpYmxlRXh0ZW5zaW9ucy5sZW5ndGggJiYgIWRvbmVDb3B5OyBqKyspIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3JjRmlsZW5hbWUyID0gYCR7c3JjRmlsZW5hbWV9LiR7cG9zc2libGVFeHRlbnNpb25zW2pdfWA7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGRlc3RGaWxlbmFtZSA9IGAke1RlbXBsYXRlSGVscGVyLnJlcGxhY2VTdWJzdGl0dXRpb25zKHN1YnN0aXR1dGlvbnMsIHNyY0ZpbGVuYW1lKX0uJHtwb3NzaWJsZUV4dGVuc2lvbnNbal19YDtcblxuICAgICAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGVzdEV4aXN0cyA9IGF3YWl0IHRoaXMuX2ZpbGVTeXN0ZW0uZmlsZUV4aXN0cyhkZXN0Rm9sZGVyLCBkZXN0RmlsZW5hbWUpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGVzdEV4aXN0cykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvZ2dlci5lcnJvcihgRGVzdGluYXRpb24gZmlsZSBleGlzdHMsIGFib3J0aW5nYCwgdW5kZWZpbmVkLCB7IHNyY0ZvbGRlciwgc3JjRmlsZW5hbWUyLCBkZXN0Rm9sZGVyLCBkZXN0RmlsZW5hbWUgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDE7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGV4aXN0cyA9IGF3YWl0IHRoaXMuX2ZpbGVTeXN0ZW0uZmlsZUV4aXN0cyhzcmNGb2xkZXIsIHNyY0ZpbGVuYW1lMik7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXhpc3RzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBjb250ZW50ID0gYXdhaXQgdGhpcy5fZmlsZVN5c3RlbS5maWxlUmVhZFRleHQoc3JjRm9sZGVyLCBzcmNGaWxlbmFtZTIpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb250ZW50LnN0YXJ0c1dpdGgoXCIhXCIpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9sb2dnZXIuZXJyb3IoY29udGVudC5zdWJzdHIoMSkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDE7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50ID0gVGVtcGxhdGVIZWxwZXIucmVwbGFjZVN1YnN0aXR1dGlvbnMoc3Vic3RpdHV0aW9ucywgY29udGVudCk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuX2ZpbGVTeXN0ZW0uZGlyZWN0b3J5Q3JlYXRlKGRlc3RGb2xkZXIpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9sb2dnZXIuaW5mbyhgV3JpdGluZyAke3RoaXMuX2ZpbGVTeXN0ZW0ucGF0aENvbWJpbmUoZGVzdEZvbGRlciwgZGVzdEZpbGVuYW1lKX1gKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5fZmlsZVN5c3RlbS5maWxlV3JpdGVUZXh0KGRlc3RGb2xkZXIsIGRlc3RGaWxlbmFtZSwgY29udGVudCk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvbmVDb3B5ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9sb2dnZXIuZXJyb3IoYFRoZXJlIHdhcyBhbiBnZW5lcmF0aW5nIGZyb20gdGhlIHRlbXBsYXRlYCwgZXJyLCB7IHNyY0ZvbGRlciwgc3JjRmlsZW5hbWUyLCBkZXN0Rm9sZGVyLCBkZXN0RmlsZW5hbWUgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIWRvbmVDb3B5KSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvZ2dlci5lcnJvcihgQ2FuIG5vdCBmaW5kIGEgc291cmNlIGZvciAnJHtzcmNGaWxlbmFtZX0nIHdpdGggdGhlIHBvc3NpYmxlIGV4dGVuc2lvbnMgWyR7cG9zc2libGVFeHRlbnNpb25zLmpvaW4oXCIsIFwiKX1dYCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiAwO1xuICAgIH1cbn1cbiJdfQ==
