"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const pipelineStepBase_1 = require("../engine/pipelineStepBase");
const templateHelper_1 = require("../helpers/templateHelper");
class SharedAppFramework extends pipelineStepBase_1.PipelineStepBase {
    generateAppSource(logger, fileSystem, uniteConfiguration, engineVariables, files, isShared) {
        return __awaiter(this, void 0, void 0, function* () {
            const appFramework = isShared ? "shared" : uniteConfiguration.applicationFramework.toLowerCase();
            const scaffoldFolder = fileSystem.pathCombine(engineVariables.engineAssetsFolder, `appFramework/${appFramework}/src/${uniteConfiguration.sourceLanguage.toLowerCase()}`);
            logger.info("Generating App Source in", { appSourceFolder: engineVariables.www.src });
            for (const file of files) {
                const ret = yield this.copyFile(logger, fileSystem, scaffoldFolder, file, engineVariables.www.src, file, engineVariables.force, engineVariables.noCreateSource, templateHelper_1.TemplateHelper.createCodeSubstitutions(engineVariables));
                if (ret !== 0) {
                    return ret;
                }
            }
            return 0;
        });
    }
    generateAppHtml(logger, fileSystem, uniteConfiguration, engineVariables, htmlFiles) {
        return __awaiter(this, void 0, void 0, function* () {
            const scaffoldFolder = fileSystem.pathCombine(engineVariables.engineAssetsFolder, `appFramework/${uniteConfiguration.applicationFramework.toLowerCase()}/src/html/`);
            logger.info("Generating App HTML in", { appSourceFolder: engineVariables.www.src });
            for (const htmlFile of htmlFiles) {
                const ret = yield this.copyFile(logger, fileSystem, scaffoldFolder, `${htmlFile}`, engineVariables.www.src, `${htmlFile}`, engineVariables.force, engineVariables.noCreateSource);
                if (ret !== 0) {
                    return ret;
                }
            }
            return 0;
        });
    }
    generateAppCss(logger, fileSystem, uniteConfiguration, engineVariables, cssFiles) {
        return __awaiter(this, void 0, void 0, function* () {
            const scaffoldFolder = fileSystem.pathCombine(engineVariables.engineAssetsFolder, `appFramework/${uniteConfiguration.applicationFramework.toLowerCase()}/src/css/${uniteConfiguration.cssPre.toLowerCase()}/`);
            logger.info("Generating App CSS in", { appSourceFolder: engineVariables.www.src });
            for (const cssFile of cssFiles) {
                const ret = yield this.copyFile(logger, fileSystem, scaffoldFolder, `${cssFile}.${uniteConfiguration.styleExtension}`, engineVariables.www.src, `${cssFile}.${uniteConfiguration.styleExtension}`, engineVariables.force, engineVariables.noCreateSource);
                if (ret !== 0) {
                    return ret;
                }
            }
            return 0;
        });
    }
    generateUnitTest(logger, fileSystem, uniteConfiguration, engineVariables, specs, isShared) {
        const _super = name => super[name];
        return __awaiter(this, void 0, void 0, function* () {
            if (!_super("condition").call(this, uniteConfiguration.unitTestRunner, "None")) {
                logger.info("Generating unit test scaffold shared", { unitTestSrcFolder: engineVariables.www.unit });
                const appFramework = isShared ? "shared" : uniteConfiguration.applicationFramework.toLowerCase();
                const unitTestsScaffold = fileSystem.pathCombine(engineVariables.engineAssetsFolder, `appFramework/${appFramework}/test/unit/src/sourceLanguage/${uniteConfiguration.sourceLanguage.toLowerCase()}/` +
                    `${uniteConfiguration.unitTestFramework.toLowerCase()}/`);
                const unitTestsRunner = fileSystem.pathCombine(engineVariables.engineAssetsFolder, `appFramework/shared/test/unit/unitTestRunner/${uniteConfiguration.unitTestRunner.toLowerCase()}/`);
                for (const spec of specs) {
                    const ret = yield this.copyFile(logger, fileSystem, unitTestsScaffold, `${spec}`, engineVariables.www.unit, `${spec}`, engineVariables.force, engineVariables.noCreateSource, templateHelper_1.TemplateHelper.createCodeSubstitutions(engineVariables));
                    if (ret !== 0) {
                        return ret;
                    }
                }
                return this.copyFile(logger, fileSystem, unitTestsRunner, "unit-bootstrap.js", engineVariables.www.unitRoot, "unit-bootstrap.js", engineVariables.force, engineVariables.noCreateSource);
            }
            else {
                return 0;
            }
        });
    }
    generateE2eTest(logger, fileSystem, uniteConfiguration, engineVariables, specs, isShared) {
        const _super = name => super[name];
        return __awaiter(this, void 0, void 0, function* () {
            if (!_super("condition").call(this, uniteConfiguration.e2eTestRunner, "None")) {
                logger.info("Generating e2e test scaffold shared", { unitTestSrcFolder: engineVariables.www.e2e });
                const appFramework = isShared ? "shared" : uniteConfiguration.applicationFramework.toLowerCase();
                const e2eTestsScaffold = fileSystem.pathCombine(engineVariables.engineAssetsFolder, `appFramework/${appFramework}/test/e2e/src/` +
                    `${uniteConfiguration.e2eTestRunner.toLowerCase()}/` +
                    `${uniteConfiguration.e2eTestFramework.toLowerCase()}/`);
                for (const spec of specs) {
                    const ret = yield this.copyFile(logger, fileSystem, e2eTestsScaffold, `${spec}`, engineVariables.www.e2e, `${spec}`, engineVariables.force, engineVariables.noCreateSource);
                    if (ret !== 0) {
                        return ret;
                    }
                }
                return 0;
            }
            else {
                return 0;
            }
        });
    }
    generateCss(logger, fileSystem, uniteConfiguration, engineVariables) {
        const _super = name => super[name];
        return __awaiter(this, void 0, void 0, function* () {
            logger.info("Generating application css scaffold shared", { cssSrcFolder: engineVariables.www.css });
            const assetCssFolder = fileSystem.pathCombine(engineVariables.engineAssetsFolder, `appFramework/shared/css/${uniteConfiguration.cssPre.toLowerCase()}`);
            const styles = ["app", "main", "reset"];
            for (const style of styles) {
                const ret = yield _super("copyFile").call(this, logger, fileSystem, assetCssFolder, `${style}.${uniteConfiguration.styleExtension}`, engineVariables.www.css, `${style}.${uniteConfiguration.styleExtension}`, engineVariables.force, engineVariables.noCreateSource);
                if (ret !== 0) {
                    return ret;
                }
            }
            return 0;
        });
    }
    createLoaderReplacement(engineVariables, extension, loader, includeRequires) {
        if (includeRequires) {
            engineVariables.buildTranspileInclude.push("const replace = require(\"gulp-replace\");");
        }
        engineVariables.buildTranspilePreBuild.push(`        .pipe(replace(/import(.*?)("|'|\`)(.*?).${extension}\\2/g, "import$1$2${loader}!$3.${extension}$2"))`);
    }
    createLoaderTypeMapReplacement(engineVariables, extension, loader) {
        engineVariables.buildTranspileInclude.push("const replace = require(\"gulp-replace\");");
        engineVariables.buildTranspileInclude.push("const clientPackages = require(\"./util/client-packages\");");
        const typeMapLoader = `\${clientPackages.getTypeMap(uniteConfig, "${loader}", buildConfiguration.minify)}`;
        engineVariables.buildTranspilePreBuild.push(`        .pipe(replace(/import(.*?)("|'|\`)(.*?).${extension}\\2/g, \`import$1$2${typeMapLoader}!$3.${extension}$2\`))`);
    }
    insertContent(logger, fileSystem, engineVariables, file, inserter) {
        return __awaiter(this, void 0, void 0, function* () {
            let ret = 0;
            try {
                const fileExists = yield fileSystem.fileExists(engineVariables.www.src, file);
                if (fileExists) {
                    let content = yield fileSystem.fileReadText(engineVariables.www.src, file);
                    content = inserter(content);
                    yield fileSystem.fileWriteText(engineVariables.www.src, file, content);
                }
            }
            catch (err) {
                ret = 1;
                logger.error(`Unable to replace content in file '${file}'`, err);
            }
            return ret;
        });
    }
    insertReplaceImports(srcContent, sourceItems) {
        let items = sourceItems;
        let content = srcContent;
        let remaining = [];
        if (items && items.length > 0) {
            const regEx = /(import.*;)/g;
            const results = content.match(regEx);
            if (results && results.length > 0) {
                items = items.filter(it => results.indexOf(it) < 0);
                if (items.length > 0) {
                    content = content.replace(results[results.length - 1], `${results[results.length - 1]}\n${items.join("\n")}`);
                }
            }
            else {
                remaining = items;
            }
        }
        return { content, remaining };
    }
    insertCompletion(logger, remainingInserts, routes) {
        const keys = Object.keys(remainingInserts || {});
        let totalRemaining = 0;
        keys.forEach(key => {
            totalRemaining += remainingInserts[key].length;
        });
        if (totalRemaining > 0) {
            logger.banner("");
            logger.banner("------------------------------------------------------------------------");
            logger.warning("We couldn't find a location to insert some of the router data, please insert the following manually:");
            logger.warning("");
            keys.forEach(key => {
                if (remainingInserts[key].length > 0) {
                    logger.banner(key);
                    logger.banner("");
                    remainingInserts[key].forEach(item => logger.banner(`   ${item.replace(/\n/g, "\n   ")}`));
                    logger.banner("");
                }
            });
            logger.banner("------------------------------------------------------------------------");
            logger.banner("");
        }
        if (routes && routes.length > 0) {
            logger.banner("Once you have built the application you should be able access the new pages at the following routes:");
            logger.banner("");
            routes.forEach(route => logger.banner(`   ${route}`));
            logger.banner("");
        }
    }
}
exports.SharedAppFramework = SharedAppFramework;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9waXBlbGluZVN0ZXBzL3NoYXJlZEFwcEZyYW1ld29yay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBT0EsaUVBQThEO0FBQzlELDhEQUEyRDtBQUUzRCxNQUFzQixrQkFBbUIsU0FBUSxtQ0FBZ0I7SUFDN0MsaUJBQWlCLENBQUMsTUFBZSxFQUNmLFVBQXVCLEVBQ3ZCLGtCQUFzQyxFQUN0QyxlQUFnQyxFQUNoQyxLQUFlLEVBQ2YsUUFBaUI7O1lBQy9DLE1BQU0sWUFBWSxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxvQkFBb0IsQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUVqRyxNQUFNLGNBQWMsR0FBRyxVQUFVLENBQUMsV0FBVyxDQUFDLGVBQWUsQ0FBQyxrQkFBa0IsRUFDbEMsZ0JBQWdCLFlBQVksUUFBUSxrQkFBa0IsQ0FBQyxjQUFjLENBQUMsV0FBVyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBRXJJLE1BQU0sQ0FBQyxJQUFJLENBQUMsMEJBQTBCLEVBQUUsRUFBRSxlQUFlLEVBQUUsZUFBZSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1lBRXRGLEtBQUssTUFBTSxJQUFJLElBQUksS0FBSyxFQUFFO2dCQUN0QixNQUFNLEdBQUcsR0FBRyxNQUFNLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLFVBQVUsRUFDbEIsY0FBYyxFQUNkLElBQUksRUFDSixlQUFlLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFDdkIsSUFBSSxFQUNKLGVBQWUsQ0FBQyxLQUFLLEVBQ3JCLGVBQWUsQ0FBQyxjQUFjLEVBQzlCLCtCQUFjLENBQUMsdUJBQXVCLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQztnQkFFekYsSUFBSSxHQUFHLEtBQUssQ0FBQyxFQUFFO29CQUNYLE9BQU8sR0FBRyxDQUFDO2lCQUNkO2FBQ0o7WUFFRCxPQUFPLENBQUMsQ0FBQztRQUNiLENBQUM7S0FBQTtJQUVlLGVBQWUsQ0FBQyxNQUFlLEVBQ2YsVUFBdUIsRUFDdkIsa0JBQXNDLEVBQ3RDLGVBQWdDLEVBQ2hDLFNBQW1COztZQUMvQyxNQUFNLGNBQWMsR0FBRyxVQUFVLENBQUMsV0FBVyxDQUFDLGVBQWUsQ0FBQyxrQkFBa0IsRUFDbEMsZ0JBQWdCLGtCQUFrQixDQUFDLG9CQUFvQixDQUFDLFdBQVcsRUFBRSxZQUFZLENBQUMsQ0FBQztZQUVqSSxNQUFNLENBQUMsSUFBSSxDQUFDLHdCQUF3QixFQUFFLEVBQUUsZUFBZSxFQUFFLGVBQWUsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztZQUVwRixLQUFLLE1BQU0sUUFBUSxJQUFJLFNBQVMsRUFBRTtnQkFDOUIsTUFBTSxHQUFHLEdBQUcsTUFBTSxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxVQUFVLEVBQ2xCLGNBQWMsRUFDZCxHQUFHLFFBQVEsRUFBRSxFQUNiLGVBQWUsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUN2QixHQUFHLFFBQVEsRUFBRSxFQUNiLGVBQWUsQ0FBQyxLQUFLLEVBQ3JCLGVBQWUsQ0FBQyxjQUFjLENBQUMsQ0FBQztnQkFDaEUsSUFBSSxHQUFHLEtBQUssQ0FBQyxFQUFFO29CQUNYLE9BQU8sR0FBRyxDQUFDO2lCQUNkO2FBQ0o7WUFFRCxPQUFPLENBQUMsQ0FBQztRQUNiLENBQUM7S0FBQTtJQUVlLGNBQWMsQ0FBQyxNQUFlLEVBQ2YsVUFBdUIsRUFDdkIsa0JBQXNDLEVBQ3RDLGVBQWdDLEVBQ2hDLFFBQWtCOztZQUM3QyxNQUFNLGNBQWMsR0FBRyxVQUFVLENBQUMsV0FBVyxDQUFDLGVBQWUsQ0FBQyxrQkFBa0IsRUFDbEMsZ0JBQWdCLGtCQUFrQixDQUFDLG9CQUFvQixDQUFDLFdBQVcsRUFBRSxZQUFZLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxXQUFXLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFDM0ssTUFBTSxDQUFDLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxFQUFFLGVBQWUsRUFBRSxlQUFlLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7WUFFbkYsS0FBSyxNQUFNLE9BQU8sSUFBSSxRQUFRLEVBQUU7Z0JBQzVCLE1BQU0sR0FBRyxHQUFHLE1BQU0sSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUUsVUFBVSxFQUNsQixjQUFjLEVBQ2QsR0FBRyxPQUFPLElBQUksa0JBQWtCLENBQUMsY0FBYyxFQUFFLEVBQ2pELGVBQWUsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUN2QixHQUFHLE9BQU8sSUFBSSxrQkFBa0IsQ0FBQyxjQUFjLEVBQUUsRUFDakQsZUFBZSxDQUFDLEtBQUssRUFDckIsZUFBZSxDQUFDLGNBQWMsQ0FBQyxDQUFDO2dCQUVoRSxJQUFJLEdBQUcsS0FBSyxDQUFDLEVBQUU7b0JBQ1gsT0FBTyxHQUFHLENBQUM7aUJBQ2Q7YUFDSjtZQUVELE9BQU8sQ0FBQyxDQUFDO1FBQ2IsQ0FBQztLQUFBO0lBRWUsZ0JBQWdCLENBQUMsTUFBZSxFQUNmLFVBQXVCLEVBQ3ZCLGtCQUFzQyxFQUN0QyxlQUFnQyxFQUNoQyxLQUFlLEVBQ2YsUUFBaUI7OztZQUM5QyxJQUFJLENBQUMsbUJBQWUsWUFBQyxrQkFBa0IsQ0FBQyxjQUFjLEVBQUUsTUFBTSxDQUFDLEVBQUU7Z0JBQzdELE1BQU0sQ0FBQyxJQUFJLENBQUMsc0NBQXNDLEVBQUUsRUFBRSxpQkFBaUIsRUFBRSxlQUFlLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7Z0JBRXJHLE1BQU0sWUFBWSxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxvQkFBb0IsQ0FBQyxXQUFXLEVBQUUsQ0FBQztnQkFFakcsTUFBTSxpQkFBaUIsR0FBRyxVQUFVLENBQUMsV0FBVyxDQUFDLGVBQWUsQ0FBQyxrQkFBa0IsRUFDbEMsZ0JBQWdCLFlBQVksaUNBQWlDLGtCQUFrQixDQUFDLGNBQWMsQ0FBQyxXQUFXLEVBQUUsR0FBRztvQkFDNUcsR0FBRyxrQkFBa0IsQ0FBQyxpQkFBaUIsQ0FBQyxXQUFXLEVBQUUsR0FBRyxDQUFDLENBQUM7Z0JBRTlHLE1BQU0sZUFBZSxHQUFHLFVBQVUsQ0FBQyxXQUFXLENBQUMsZUFBZSxDQUFDLGtCQUFrQixFQUNsQyxnREFBZ0Qsa0JBQWtCLENBQUMsY0FBYyxDQUFDLFdBQVcsRUFBRSxHQUFHLENBQUMsQ0FBQztnQkFFbkosS0FBSyxNQUFNLElBQUksSUFBSSxLQUFLLEVBQUU7b0JBQ3RCLE1BQU0sR0FBRyxHQUFHLE1BQU0sSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUUsVUFBVSxFQUFFLGlCQUFpQixFQUNyQyxHQUFHLElBQUksRUFBRSxFQUNULGVBQWUsQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUN4QixHQUFHLElBQUksRUFBRSxFQUNULGVBQWUsQ0FBQyxLQUFLLEVBQ3JCLGVBQWUsQ0FBQyxjQUFjLEVBQzlCLCtCQUFjLENBQUMsdUJBQXVCLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQztvQkFDekYsSUFBSSxHQUFHLEtBQUssQ0FBQyxFQUFFO3dCQUNYLE9BQU8sR0FBRyxDQUFDO3FCQUNkO2lCQUNKO2dCQUVELE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUUsVUFBVSxFQUFFLGVBQWUsRUFDbkMsbUJBQW1CLEVBQ25CLGVBQWUsQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUM1QixtQkFBbUIsRUFDbkIsZUFBZSxDQUFDLEtBQUssRUFDckIsZUFBZSxDQUFDLGNBQWMsQ0FBQyxDQUFDO2FBRXhEO2lCQUFNO2dCQUNILE9BQU8sQ0FBQyxDQUFDO2FBQ1o7UUFDTCxDQUFDO0tBQUE7SUFFZSxlQUFlLENBQUMsTUFBZSxFQUNmLFVBQXVCLEVBQ3ZCLGtCQUFzQyxFQUN0QyxlQUFnQyxFQUNoQyxLQUFlLEVBQ2YsUUFBaUI7OztZQUM3QyxJQUFJLENBQUMsbUJBQWUsWUFBQyxrQkFBa0IsQ0FBQyxhQUFhLEVBQUUsTUFBTSxDQUFDLEVBQUU7Z0JBQzVELE1BQU0sQ0FBQyxJQUFJLENBQUMscUNBQXFDLEVBQUUsRUFBRSxpQkFBaUIsRUFBRSxlQUFlLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7Z0JBRW5HLE1BQU0sWUFBWSxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxvQkFBb0IsQ0FBQyxXQUFXLEVBQUUsQ0FBQztnQkFFakcsTUFBTSxnQkFBZ0IsR0FBRyxVQUFVLENBQUMsV0FBVyxDQUFDLGVBQWUsQ0FBQyxrQkFBa0IsRUFDbEMsZ0JBQWdCLFlBQVksZ0JBQWdCO29CQUM1QyxHQUFHLGtCQUFrQixDQUFDLGFBQWEsQ0FBQyxXQUFXLEVBQUUsR0FBRztvQkFDcEQsR0FBRyxrQkFBa0IsQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLEVBQUUsR0FBRyxDQUFDLENBQUM7Z0JBRXpHLEtBQUssTUFBTSxJQUFJLElBQUksS0FBSyxFQUFFO29CQUN0QixNQUFNLEdBQUcsR0FBRyxNQUFNLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLFVBQVUsRUFBRSxnQkFBZ0IsRUFDcEMsR0FBRyxJQUFJLEVBQUUsRUFDVCxlQUFlLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFDdkIsR0FBRyxJQUFJLEVBQUUsRUFDVCxlQUFlLENBQUMsS0FBSyxFQUNyQixlQUFlLENBQUMsY0FBYyxDQUFDLENBQUM7b0JBRWhFLElBQUksR0FBRyxLQUFLLENBQUMsRUFBRTt3QkFDWCxPQUFPLEdBQUcsQ0FBQztxQkFDZDtpQkFDSjtnQkFFRCxPQUFPLENBQUMsQ0FBQzthQUNaO2lCQUFNO2dCQUNILE9BQU8sQ0FBQyxDQUFDO2FBQ1o7UUFDTCxDQUFDO0tBQUE7SUFFZSxXQUFXLENBQUMsTUFBZSxFQUFFLFVBQXVCLEVBQUUsa0JBQXNDLEVBQUUsZUFBZ0M7OztZQUMxSSxNQUFNLENBQUMsSUFBSSxDQUFDLDRDQUE0QyxFQUFFLEVBQUUsWUFBWSxFQUFFLGVBQWUsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztZQUVyRyxNQUFNLGNBQWMsR0FBRyxVQUFVLENBQUMsV0FBVyxDQUFDLGVBQWUsQ0FBQyxrQkFBa0IsRUFBRSwyQkFBMkIsa0JBQWtCLENBQUMsTUFBTSxDQUFDLFdBQVcsRUFBRSxFQUFFLENBQUMsQ0FBQztZQUV4SixNQUFNLE1BQU0sR0FBRyxDQUFDLEtBQUssRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUM7WUFFeEMsS0FBSyxNQUFNLEtBQUssSUFBSSxNQUFNLEVBQUU7Z0JBQ3hCLE1BQU0sR0FBRyxHQUFHLE1BQU0sa0JBQWMsWUFBQyxNQUFNLEVBQUUsVUFBVSxFQUFFLGNBQWMsRUFDbEMsR0FBRyxLQUFLLElBQUksa0JBQWtCLENBQUMsY0FBYyxFQUFFLEVBQUUsZUFBZSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsR0FBRyxLQUFLLElBQUksa0JBQWtCLENBQUMsY0FBYyxFQUFFLEVBQ3pILGVBQWUsQ0FBQyxLQUFLLEVBQ3JCLGVBQWUsQ0FBQyxjQUFjLENBQUMsQ0FBQztnQkFFakUsSUFBSSxHQUFHLEtBQUssQ0FBQyxFQUFFO29CQUNYLE9BQU8sR0FBRyxDQUFDO2lCQUNkO2FBQ0o7WUFFRCxPQUFPLENBQUMsQ0FBQztRQUNiLENBQUM7S0FBQTtJQUVTLHVCQUF1QixDQUFDLGVBQWdDLEVBQUUsU0FBaUIsRUFBRSxNQUFjLEVBQUUsZUFBd0I7UUFDM0gsSUFBSSxlQUFlLEVBQUU7WUFDakIsZUFBZSxDQUFDLHFCQUFxQixDQUFDLElBQUksQ0FBQyw0Q0FBNEMsQ0FBQyxDQUFDO1NBQzVGO1FBQ0QsZUFBZSxDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FBQyxtREFBbUQsU0FBUyxxQkFBcUIsTUFBTSxPQUFPLFNBQVMsT0FBTyxDQUFDLENBQUM7SUFDaEssQ0FBQztJQUVTLDhCQUE4QixDQUFDLGVBQWdDLEVBQUUsU0FBaUIsRUFBRSxNQUFjO1FBQ3hHLGVBQWUsQ0FBQyxxQkFBcUIsQ0FBQyxJQUFJLENBQUMsNENBQTRDLENBQUMsQ0FBQztRQUN6RixlQUFlLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLDZEQUE2RCxDQUFDLENBQUM7UUFFMUcsTUFBTSxhQUFhLEdBQUcsOENBQThDLE1BQU0sZ0NBQWdDLENBQUM7UUFDM0csZUFBZSxDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FBQyxtREFBbUQsU0FBUyxzQkFBc0IsYUFBYSxPQUFPLFNBQVMsUUFBUSxDQUFDLENBQUM7SUFDekssQ0FBQztJQUVlLGFBQWEsQ0FBQyxNQUFlLEVBQ2YsVUFBdUIsRUFDdkIsZUFBZ0MsRUFDaEMsSUFBWSxFQUNaLFFBQXFDOztZQUMvRCxJQUFJLEdBQUcsR0FBRyxDQUFDLENBQUM7WUFFWixJQUFJO2dCQUNBLE1BQU0sVUFBVSxHQUFHLE1BQU0sVUFBVSxDQUFDLFVBQVUsQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQztnQkFDOUUsSUFBSSxVQUFVLEVBQUU7b0JBQ1osSUFBSSxPQUFPLEdBQUcsTUFBTSxVQUFVLENBQUMsWUFBWSxDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDO29CQUUzRSxPQUFPLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDO29CQUU1QixNQUFNLFVBQVUsQ0FBQyxhQUFhLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO2lCQUMxRTthQUNKO1lBQUMsT0FBTyxHQUFHLEVBQUU7Z0JBQ1YsR0FBRyxHQUFHLENBQUMsQ0FBQztnQkFDUixNQUFNLENBQUMsS0FBSyxDQUFDLHNDQUFzQyxJQUFJLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQzthQUNwRTtZQUVELE9BQU8sR0FBRyxDQUFDO1FBQ2YsQ0FBQztLQUFBO0lBRVMsb0JBQW9CLENBQUMsVUFBa0IsRUFBRSxXQUFxQjtRQUNwRSxJQUFJLEtBQUssR0FBRyxXQUFXLENBQUM7UUFDeEIsSUFBSSxPQUFPLEdBQUcsVUFBVSxDQUFDO1FBQ3pCLElBQUksU0FBUyxHQUFhLEVBQUUsQ0FBQztRQUM3QixJQUFJLEtBQUssSUFBSSxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUMzQixNQUFNLEtBQUssR0FBRyxjQUFjLENBQUM7WUFFN0IsTUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNyQyxJQUFJLE9BQU8sSUFBSSxPQUFPLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtnQkFDL0IsS0FBSyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO2dCQUVwRCxJQUFJLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO29CQUNsQixPQUFPLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsRUFBRSxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxLQUFLLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2lCQUNqSDthQUNKO2lCQUFNO2dCQUNILFNBQVMsR0FBRyxLQUFLLENBQUM7YUFDckI7U0FDSjtRQUVELE9BQU8sRUFBRSxPQUFPLEVBQUUsU0FBUyxFQUFFLENBQUM7SUFDbEMsQ0FBQztJQUVTLGdCQUFnQixDQUFDLE1BQWUsRUFDZixnQkFBMkMsRUFDM0MsTUFBZ0I7UUFFdkMsTUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUNqRCxJQUFJLGNBQWMsR0FBRyxDQUFDLENBQUM7UUFDdkIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUNmLGNBQWMsSUFBSSxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUM7UUFDbkQsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLGNBQWMsR0FBRyxDQUFDLEVBQUU7WUFDcEIsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUNsQixNQUFNLENBQUMsTUFBTSxDQUFDLDBFQUEwRSxDQUFDLENBQUM7WUFDMUYsTUFBTSxDQUFDLE9BQU8sQ0FBQyxzR0FBc0csQ0FBQyxDQUFDO1lBQ3ZILE1BQU0sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDbkIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRTtnQkFDZixJQUFJLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7b0JBQ2xDLE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7b0JBQ25CLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7b0JBQ2xCLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztvQkFDM0YsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztpQkFDckI7WUFDTCxDQUFDLENBQUMsQ0FBQztZQUNILE1BQU0sQ0FBQyxNQUFNLENBQUMsMEVBQTBFLENBQUMsQ0FBQztZQUMxRixNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1NBQ3JCO1FBRUQsSUFBSSxNQUFNLElBQUksTUFBTSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDN0IsTUFBTSxDQUFDLE1BQU0sQ0FBQyxzR0FBc0csQ0FBQyxDQUFDO1lBQ3RILE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDbEIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDdEQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUNyQjtJQUNMLENBQUM7Q0FDSjtBQXRSRCxnREFzUkMiLCJmaWxlIjoicGlwZWxpbmVTdGVwcy9zaGFyZWRBcHBGcmFtZXdvcmsuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFBpcGVsaW5lIHN0ZXAgdG8gZ2VuZXJhdGUgc2NhZmZvbGRpbmcgZm9yIHNoYXJlZCBhcHBsaWNhdGlvbi5cbiAqL1xuaW1wb3J0IHsgSUZpbGVTeXN0ZW0gfSBmcm9tIFwidW5pdGVqcy1mcmFtZXdvcmsvZGlzdC9pbnRlcmZhY2VzL0lGaWxlU3lzdGVtXCI7XG5pbXBvcnQgeyBJTG9nZ2VyIH0gZnJvbSBcInVuaXRlanMtZnJhbWV3b3JrL2Rpc3QvaW50ZXJmYWNlcy9JTG9nZ2VyXCI7XG5pbXBvcnQgeyBVbml0ZUNvbmZpZ3VyYXRpb24gfSBmcm9tIFwiLi4vY29uZmlndXJhdGlvbi9tb2RlbHMvdW5pdGUvdW5pdGVDb25maWd1cmF0aW9uXCI7XG5pbXBvcnQgeyBFbmdpbmVWYXJpYWJsZXMgfSBmcm9tIFwiLi4vZW5naW5lL2VuZ2luZVZhcmlhYmxlc1wiO1xuaW1wb3J0IHsgUGlwZWxpbmVTdGVwQmFzZSB9IGZyb20gXCIuLi9lbmdpbmUvcGlwZWxpbmVTdGVwQmFzZVwiO1xuaW1wb3J0IHsgVGVtcGxhdGVIZWxwZXIgfSBmcm9tIFwiLi4vaGVscGVycy90ZW1wbGF0ZUhlbHBlclwiO1xuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgU2hhcmVkQXBwRnJhbWV3b3JrIGV4dGVuZHMgUGlwZWxpbmVTdGVwQmFzZSB7XG4gICAgcHJvdGVjdGVkIGFzeW5jIGdlbmVyYXRlQXBwU291cmNlKGxvZ2dlcjogSUxvZ2dlcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZVN5c3RlbTogSUZpbGVTeXN0ZW0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVuaXRlQ29uZmlndXJhdGlvbjogVW5pdGVDb25maWd1cmF0aW9uLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVWYXJpYWJsZXM6IEVuZ2luZVZhcmlhYmxlcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZXM6IHN0cmluZ1tdLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc1NoYXJlZDogYm9vbGVhbik6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgICAgIGNvbnN0IGFwcEZyYW1ld29yayA9IGlzU2hhcmVkID8gXCJzaGFyZWRcIiA6IHVuaXRlQ29uZmlndXJhdGlvbi5hcHBsaWNhdGlvbkZyYW1ld29yay50b0xvd2VyQ2FzZSgpO1xuXG4gICAgICAgIGNvbnN0IHNjYWZmb2xkRm9sZGVyID0gZmlsZVN5c3RlbS5wYXRoQ29tYmluZShlbmdpbmVWYXJpYWJsZXMuZW5naW5lQXNzZXRzRm9sZGVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYGFwcEZyYW1ld29yay8ke2FwcEZyYW1ld29ya30vc3JjLyR7dW5pdGVDb25maWd1cmF0aW9uLnNvdXJjZUxhbmd1YWdlLnRvTG93ZXJDYXNlKCl9YCk7XG5cbiAgICAgICAgbG9nZ2VyLmluZm8oXCJHZW5lcmF0aW5nIEFwcCBTb3VyY2UgaW5cIiwgeyBhcHBTb3VyY2VGb2xkZXI6IGVuZ2luZVZhcmlhYmxlcy53d3cuc3JjIH0pO1xuXG4gICAgICAgIGZvciAoY29uc3QgZmlsZSBvZiBmaWxlcykge1xuICAgICAgICAgICAgY29uc3QgcmV0ID0gYXdhaXQgdGhpcy5jb3B5RmlsZShsb2dnZXIsIGZpbGVTeXN0ZW0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjYWZmb2xkRm9sZGVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVWYXJpYWJsZXMud3d3LnNyYyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lVmFyaWFibGVzLmZvcmNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVWYXJpYWJsZXMubm9DcmVhdGVTb3VyY2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRlbXBsYXRlSGVscGVyLmNyZWF0ZUNvZGVTdWJzdGl0dXRpb25zKGVuZ2luZVZhcmlhYmxlcykpO1xuXG4gICAgICAgICAgICBpZiAocmV0ICE9PSAwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJldDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiAwO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBhc3luYyBnZW5lcmF0ZUFwcEh0bWwobG9nZ2VyOiBJTG9nZ2VyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZVN5c3RlbTogSUZpbGVTeXN0ZW0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1bml0ZUNvbmZpZ3VyYXRpb246IFVuaXRlQ29uZmlndXJhdGlvbixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZVZhcmlhYmxlczogRW5naW5lVmFyaWFibGVzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaHRtbEZpbGVzOiBzdHJpbmdbXSk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgICAgIGNvbnN0IHNjYWZmb2xkRm9sZGVyID0gZmlsZVN5c3RlbS5wYXRoQ29tYmluZShlbmdpbmVWYXJpYWJsZXMuZW5naW5lQXNzZXRzRm9sZGVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYGFwcEZyYW1ld29yay8ke3VuaXRlQ29uZmlndXJhdGlvbi5hcHBsaWNhdGlvbkZyYW1ld29yay50b0xvd2VyQ2FzZSgpfS9zcmMvaHRtbC9gKTtcblxuICAgICAgICBsb2dnZXIuaW5mbyhcIkdlbmVyYXRpbmcgQXBwIEhUTUwgaW5cIiwgeyBhcHBTb3VyY2VGb2xkZXI6IGVuZ2luZVZhcmlhYmxlcy53d3cuc3JjIH0pO1xuXG4gICAgICAgIGZvciAoY29uc3QgaHRtbEZpbGUgb2YgaHRtbEZpbGVzKSB7XG4gICAgICAgICAgICBjb25zdCByZXQgPSBhd2FpdCB0aGlzLmNvcHlGaWxlKGxvZ2dlciwgZmlsZVN5c3RlbSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhZmZvbGRGb2xkZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGAke2h0bWxGaWxlfWAsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZVZhcmlhYmxlcy53d3cuc3JjLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgJHtodG1sRmlsZX1gLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVWYXJpYWJsZXMuZm9yY2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZVZhcmlhYmxlcy5ub0NyZWF0ZVNvdXJjZSk7XG4gICAgICAgICAgICBpZiAocmV0ICE9PSAwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJldDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiAwO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBhc3luYyBnZW5lcmF0ZUFwcENzcyhsb2dnZXI6IElMb2dnZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVTeXN0ZW06IElGaWxlU3lzdGVtLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1bml0ZUNvbmZpZ3VyYXRpb246IFVuaXRlQ29uZmlndXJhdGlvbixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lVmFyaWFibGVzOiBFbmdpbmVWYXJpYWJsZXMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNzc0ZpbGVzOiBzdHJpbmdbXSk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgICAgIGNvbnN0IHNjYWZmb2xkRm9sZGVyID0gZmlsZVN5c3RlbS5wYXRoQ29tYmluZShlbmdpbmVWYXJpYWJsZXMuZW5naW5lQXNzZXRzRm9sZGVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYGFwcEZyYW1ld29yay8ke3VuaXRlQ29uZmlndXJhdGlvbi5hcHBsaWNhdGlvbkZyYW1ld29yay50b0xvd2VyQ2FzZSgpfS9zcmMvY3NzLyR7dW5pdGVDb25maWd1cmF0aW9uLmNzc1ByZS50b0xvd2VyQ2FzZSgpfS9gKTtcbiAgICAgICAgbG9nZ2VyLmluZm8oXCJHZW5lcmF0aW5nIEFwcCBDU1MgaW5cIiwgeyBhcHBTb3VyY2VGb2xkZXI6IGVuZ2luZVZhcmlhYmxlcy53d3cuc3JjIH0pO1xuXG4gICAgICAgIGZvciAoY29uc3QgY3NzRmlsZSBvZiBjc3NGaWxlcykge1xuICAgICAgICAgICAgY29uc3QgcmV0ID0gYXdhaXQgdGhpcy5jb3B5RmlsZShsb2dnZXIsIGZpbGVTeXN0ZW0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjYWZmb2xkRm9sZGVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgJHtjc3NGaWxlfS4ke3VuaXRlQ29uZmlndXJhdGlvbi5zdHlsZUV4dGVuc2lvbn1gLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVWYXJpYWJsZXMud3d3LnNyYyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYCR7Y3NzRmlsZX0uJHt1bml0ZUNvbmZpZ3VyYXRpb24uc3R5bGVFeHRlbnNpb259YCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lVmFyaWFibGVzLmZvcmNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVWYXJpYWJsZXMubm9DcmVhdGVTb3VyY2UpO1xuXG4gICAgICAgICAgICBpZiAocmV0ICE9PSAwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJldDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiAwO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBhc3luYyBnZW5lcmF0ZVVuaXRUZXN0KGxvZ2dlcjogSUxvZ2dlcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlU3lzdGVtOiBJRmlsZVN5c3RlbSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1bml0ZUNvbmZpZ3VyYXRpb246IFVuaXRlQ29uZmlndXJhdGlvbixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVWYXJpYWJsZXM6IEVuZ2luZVZhcmlhYmxlcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGVjczogc3RyaW5nW10sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNTaGFyZWQ6IGJvb2xlYW4pOiBQcm9taXNlPG51bWJlcj4ge1xuICAgICAgICBpZiAoIXN1cGVyLmNvbmRpdGlvbih1bml0ZUNvbmZpZ3VyYXRpb24udW5pdFRlc3RSdW5uZXIsIFwiTm9uZVwiKSkge1xuICAgICAgICAgICAgbG9nZ2VyLmluZm8oXCJHZW5lcmF0aW5nIHVuaXQgdGVzdCBzY2FmZm9sZCBzaGFyZWRcIiwgeyB1bml0VGVzdFNyY0ZvbGRlcjogZW5naW5lVmFyaWFibGVzLnd3dy51bml0IH0pO1xuXG4gICAgICAgICAgICBjb25zdCBhcHBGcmFtZXdvcmsgPSBpc1NoYXJlZCA/IFwic2hhcmVkXCIgOiB1bml0ZUNvbmZpZ3VyYXRpb24uYXBwbGljYXRpb25GcmFtZXdvcmsudG9Mb3dlckNhc2UoKTtcblxuICAgICAgICAgICAgY29uc3QgdW5pdFRlc3RzU2NhZmZvbGQgPSBmaWxlU3lzdGVtLnBhdGhDb21iaW5lKGVuZ2luZVZhcmlhYmxlcy5lbmdpbmVBc3NldHNGb2xkZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYGFwcEZyYW1ld29yay8ke2FwcEZyYW1ld29ya30vdGVzdC91bml0L3NyYy9zb3VyY2VMYW5ndWFnZS8ke3VuaXRlQ29uZmlndXJhdGlvbi5zb3VyY2VMYW5ndWFnZS50b0xvd2VyQ2FzZSgpfS9gICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgJHt1bml0ZUNvbmZpZ3VyYXRpb24udW5pdFRlc3RGcmFtZXdvcmsudG9Mb3dlckNhc2UoKX0vYCk7XG5cbiAgICAgICAgICAgIGNvbnN0IHVuaXRUZXN0c1J1bm5lciA9IGZpbGVTeXN0ZW0ucGF0aENvbWJpbmUoZW5naW5lVmFyaWFibGVzLmVuZ2luZUFzc2V0c0ZvbGRlcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYGFwcEZyYW1ld29yay9zaGFyZWQvdGVzdC91bml0L3VuaXRUZXN0UnVubmVyLyR7dW5pdGVDb25maWd1cmF0aW9uLnVuaXRUZXN0UnVubmVyLnRvTG93ZXJDYXNlKCl9L2ApO1xuXG4gICAgICAgICAgICBmb3IgKGNvbnN0IHNwZWMgb2Ygc3BlY3MpIHtcbiAgICAgICAgICAgICAgICBjb25zdCByZXQgPSBhd2FpdCB0aGlzLmNvcHlGaWxlKGxvZ2dlciwgZmlsZVN5c3RlbSwgdW5pdFRlc3RzU2NhZmZvbGQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgJHtzcGVjfWAsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVWYXJpYWJsZXMud3d3LnVuaXQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgJHtzcGVjfWAsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVWYXJpYWJsZXMuZm9yY2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVWYXJpYWJsZXMubm9DcmVhdGVTb3VyY2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUZW1wbGF0ZUhlbHBlci5jcmVhdGVDb2RlU3Vic3RpdHV0aW9ucyhlbmdpbmVWYXJpYWJsZXMpKTtcbiAgICAgICAgICAgICAgICBpZiAocmV0ICE9PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5jb3B5RmlsZShsb2dnZXIsIGZpbGVTeXN0ZW0sIHVuaXRUZXN0c1J1bm5lcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwidW5pdC1ib290c3RyYXAuanNcIixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZVZhcmlhYmxlcy53d3cudW5pdFJvb3QsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcInVuaXQtYm9vdHN0cmFwLmpzXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVWYXJpYWJsZXMuZm9yY2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVWYXJpYWJsZXMubm9DcmVhdGVTb3VyY2UpO1xuXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gMDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByb3RlY3RlZCBhc3luYyBnZW5lcmF0ZUUyZVRlc3QobG9nZ2VyOiBJTG9nZ2VyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZVN5c3RlbTogSUZpbGVTeXN0ZW0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1bml0ZUNvbmZpZ3VyYXRpb246IFVuaXRlQ29uZmlndXJhdGlvbixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZVZhcmlhYmxlczogRW5naW5lVmFyaWFibGVzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3BlY3M6IHN0cmluZ1tdLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNTaGFyZWQ6IGJvb2xlYW4pOiBQcm9taXNlPG51bWJlcj4ge1xuICAgICAgICBpZiAoIXN1cGVyLmNvbmRpdGlvbih1bml0ZUNvbmZpZ3VyYXRpb24uZTJlVGVzdFJ1bm5lciwgXCJOb25lXCIpKSB7XG4gICAgICAgICAgICBsb2dnZXIuaW5mbyhcIkdlbmVyYXRpbmcgZTJlIHRlc3Qgc2NhZmZvbGQgc2hhcmVkXCIsIHsgdW5pdFRlc3RTcmNGb2xkZXI6IGVuZ2luZVZhcmlhYmxlcy53d3cuZTJlIH0pO1xuXG4gICAgICAgICAgICBjb25zdCBhcHBGcmFtZXdvcmsgPSBpc1NoYXJlZCA/IFwic2hhcmVkXCIgOiB1bml0ZUNvbmZpZ3VyYXRpb24uYXBwbGljYXRpb25GcmFtZXdvcmsudG9Mb3dlckNhc2UoKTtcblxuICAgICAgICAgICAgY29uc3QgZTJlVGVzdHNTY2FmZm9sZCA9IGZpbGVTeXN0ZW0ucGF0aENvbWJpbmUoZW5naW5lVmFyaWFibGVzLmVuZ2luZUFzc2V0c0ZvbGRlcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGBhcHBGcmFtZXdvcmsvJHthcHBGcmFtZXdvcmt9L3Rlc3QvZTJlL3NyYy9gICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGAke3VuaXRlQ29uZmlndXJhdGlvbi5lMmVUZXN0UnVubmVyLnRvTG93ZXJDYXNlKCl9L2AgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYCR7dW5pdGVDb25maWd1cmF0aW9uLmUyZVRlc3RGcmFtZXdvcmsudG9Mb3dlckNhc2UoKX0vYCk7XG5cbiAgICAgICAgICAgIGZvciAoY29uc3Qgc3BlYyBvZiBzcGVjcykge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJldCA9IGF3YWl0IHRoaXMuY29weUZpbGUobG9nZ2VyLCBmaWxlU3lzdGVtLCBlMmVUZXN0c1NjYWZmb2xkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYCR7c3BlY31gLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lVmFyaWFibGVzLnd3dy5lMmUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgJHtzcGVjfWAsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVWYXJpYWJsZXMuZm9yY2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVWYXJpYWJsZXMubm9DcmVhdGVTb3VyY2UpO1xuXG4gICAgICAgICAgICAgICAgaWYgKHJldCAhPT0gMCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmV0O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIDA7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gMDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByb3RlY3RlZCBhc3luYyBnZW5lcmF0ZUNzcyhsb2dnZXI6IElMb2dnZXIsIGZpbGVTeXN0ZW06IElGaWxlU3lzdGVtLCB1bml0ZUNvbmZpZ3VyYXRpb246IFVuaXRlQ29uZmlndXJhdGlvbiwgZW5naW5lVmFyaWFibGVzOiBFbmdpbmVWYXJpYWJsZXMpOiBQcm9taXNlPG51bWJlcj4ge1xuICAgICAgICBsb2dnZXIuaW5mbyhcIkdlbmVyYXRpbmcgYXBwbGljYXRpb24gY3NzIHNjYWZmb2xkIHNoYXJlZFwiLCB7IGNzc1NyY0ZvbGRlcjogZW5naW5lVmFyaWFibGVzLnd3dy5jc3MgfSk7XG5cbiAgICAgICAgY29uc3QgYXNzZXRDc3NGb2xkZXIgPSBmaWxlU3lzdGVtLnBhdGhDb21iaW5lKGVuZ2luZVZhcmlhYmxlcy5lbmdpbmVBc3NldHNGb2xkZXIsIGBhcHBGcmFtZXdvcmsvc2hhcmVkL2Nzcy8ke3VuaXRlQ29uZmlndXJhdGlvbi5jc3NQcmUudG9Mb3dlckNhc2UoKX1gKTtcblxuICAgICAgICBjb25zdCBzdHlsZXMgPSBbXCJhcHBcIiwgXCJtYWluXCIsIFwicmVzZXRcIl07XG5cbiAgICAgICAgZm9yIChjb25zdCBzdHlsZSBvZiBzdHlsZXMpIHtcbiAgICAgICAgICAgIGNvbnN0IHJldCA9IGF3YWl0IHN1cGVyLmNvcHlGaWxlKGxvZ2dlciwgZmlsZVN5c3RlbSwgYXNzZXRDc3NGb2xkZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgJHtzdHlsZX0uJHt1bml0ZUNvbmZpZ3VyYXRpb24uc3R5bGVFeHRlbnNpb259YCwgZW5naW5lVmFyaWFibGVzLnd3dy5jc3MsIGAke3N0eWxlfS4ke3VuaXRlQ29uZmlndXJhdGlvbi5zdHlsZUV4dGVuc2lvbn1gLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lVmFyaWFibGVzLmZvcmNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5naW5lVmFyaWFibGVzLm5vQ3JlYXRlU291cmNlKTtcblxuICAgICAgICAgICAgaWYgKHJldCAhPT0gMCkge1xuICAgICAgICAgICAgICAgIHJldHVybiByZXQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gMDtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgY3JlYXRlTG9hZGVyUmVwbGFjZW1lbnQoZW5naW5lVmFyaWFibGVzOiBFbmdpbmVWYXJpYWJsZXMsIGV4dGVuc2lvbjogc3RyaW5nLCBsb2FkZXI6IHN0cmluZywgaW5jbHVkZVJlcXVpcmVzOiBib29sZWFuKSA6IHZvaWQge1xuICAgICAgICBpZiAoaW5jbHVkZVJlcXVpcmVzKSB7XG4gICAgICAgICAgICBlbmdpbmVWYXJpYWJsZXMuYnVpbGRUcmFuc3BpbGVJbmNsdWRlLnB1c2goXCJjb25zdCByZXBsYWNlID0gcmVxdWlyZShcXFwiZ3VscC1yZXBsYWNlXFxcIik7XCIpO1xuICAgICAgICB9XG4gICAgICAgIGVuZ2luZVZhcmlhYmxlcy5idWlsZFRyYW5zcGlsZVByZUJ1aWxkLnB1c2goYCAgICAgICAgLnBpcGUocmVwbGFjZSgvaW1wb3J0KC4qPykoXCJ8J3xcXGApKC4qPykuJHtleHRlbnNpb259XFxcXDIvZywgXCJpbXBvcnQkMSQyJHtsb2FkZXJ9ISQzLiR7ZXh0ZW5zaW9ufSQyXCIpKWApO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBjcmVhdGVMb2FkZXJUeXBlTWFwUmVwbGFjZW1lbnQoZW5naW5lVmFyaWFibGVzOiBFbmdpbmVWYXJpYWJsZXMsIGV4dGVuc2lvbjogc3RyaW5nLCBsb2FkZXI6IHN0cmluZykgOiB2b2lkIHtcbiAgICAgICAgZW5naW5lVmFyaWFibGVzLmJ1aWxkVHJhbnNwaWxlSW5jbHVkZS5wdXNoKFwiY29uc3QgcmVwbGFjZSA9IHJlcXVpcmUoXFxcImd1bHAtcmVwbGFjZVxcXCIpO1wiKTtcbiAgICAgICAgZW5naW5lVmFyaWFibGVzLmJ1aWxkVHJhbnNwaWxlSW5jbHVkZS5wdXNoKFwiY29uc3QgY2xpZW50UGFja2FnZXMgPSByZXF1aXJlKFxcXCIuL3V0aWwvY2xpZW50LXBhY2thZ2VzXFxcIik7XCIpO1xuXG4gICAgICAgIGNvbnN0IHR5cGVNYXBMb2FkZXIgPSBgXFwke2NsaWVudFBhY2thZ2VzLmdldFR5cGVNYXAodW5pdGVDb25maWcsIFwiJHtsb2FkZXJ9XCIsIGJ1aWxkQ29uZmlndXJhdGlvbi5taW5pZnkpfWA7XG4gICAgICAgIGVuZ2luZVZhcmlhYmxlcy5idWlsZFRyYW5zcGlsZVByZUJ1aWxkLnB1c2goYCAgICAgICAgLnBpcGUocmVwbGFjZSgvaW1wb3J0KC4qPykoXCJ8J3xcXGApKC4qPykuJHtleHRlbnNpb259XFxcXDIvZywgXFxgaW1wb3J0JDEkMiR7dHlwZU1hcExvYWRlcn0hJDMuJHtleHRlbnNpb259JDJcXGApKWApO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBhc3luYyBpbnNlcnRDb250ZW50KGxvZ2dlcjogSUxvZ2dlcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlU3lzdGVtOiBJRmlsZVN5c3RlbSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVWYXJpYWJsZXM6IEVuZ2luZVZhcmlhYmxlcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlOiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zZXJ0ZXI6IChjb250ZW50OiBzdHJpbmcpID0+IHN0cmluZyk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgICAgIGxldCByZXQgPSAwO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBmaWxlRXhpc3RzID0gYXdhaXQgZmlsZVN5c3RlbS5maWxlRXhpc3RzKGVuZ2luZVZhcmlhYmxlcy53d3cuc3JjLCBmaWxlKTtcbiAgICAgICAgICAgIGlmIChmaWxlRXhpc3RzKSB7XG4gICAgICAgICAgICAgICAgbGV0IGNvbnRlbnQgPSBhd2FpdCBmaWxlU3lzdGVtLmZpbGVSZWFkVGV4dChlbmdpbmVWYXJpYWJsZXMud3d3LnNyYywgZmlsZSk7XG5cbiAgICAgICAgICAgICAgICBjb250ZW50ID0gaW5zZXJ0ZXIoY29udGVudCk7XG5cbiAgICAgICAgICAgICAgICBhd2FpdCBmaWxlU3lzdGVtLmZpbGVXcml0ZVRleHQoZW5naW5lVmFyaWFibGVzLnd3dy5zcmMsIGZpbGUsIGNvbnRlbnQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIHJldCA9IDE7XG4gICAgICAgICAgICBsb2dnZXIuZXJyb3IoYFVuYWJsZSB0byByZXBsYWNlIGNvbnRlbnQgaW4gZmlsZSAnJHtmaWxlfSdgLCBlcnIpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJldDtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgaW5zZXJ0UmVwbGFjZUltcG9ydHMoc3JjQ29udGVudDogc3RyaW5nLCBzb3VyY2VJdGVtczogc3RyaW5nW10pOiB7IGNvbnRlbnQ6IHN0cmluZzsgcmVtYWluaW5nOiBzdHJpbmdbXSB9IHtcbiAgICAgICAgbGV0IGl0ZW1zID0gc291cmNlSXRlbXM7XG4gICAgICAgIGxldCBjb250ZW50ID0gc3JjQ29udGVudDtcbiAgICAgICAgbGV0IHJlbWFpbmluZzogc3RyaW5nW10gPSBbXTtcbiAgICAgICAgaWYgKGl0ZW1zICYmIGl0ZW1zLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGNvbnN0IHJlZ0V4ID0gLyhpbXBvcnQuKjspL2c7XG5cbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdHMgPSBjb250ZW50Lm1hdGNoKHJlZ0V4KTtcbiAgICAgICAgICAgIGlmIChyZXN1bHRzICYmIHJlc3VsdHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIGl0ZW1zID0gaXRlbXMuZmlsdGVyKGl0ID0+IHJlc3VsdHMuaW5kZXhPZihpdCkgPCAwKTtcblxuICAgICAgICAgICAgICAgIGlmIChpdGVtcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRlbnQgPSBjb250ZW50LnJlcGxhY2UocmVzdWx0c1tyZXN1bHRzLmxlbmd0aCAtIDFdLCBgJHtyZXN1bHRzW3Jlc3VsdHMubGVuZ3RoIC0gMV19XFxuJHtpdGVtcy5qb2luKFwiXFxuXCIpfWApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmVtYWluaW5nID0gaXRlbXM7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4geyBjb250ZW50LCByZW1haW5pbmcgfTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgaW5zZXJ0Q29tcGxldGlvbihsb2dnZXI6IElMb2dnZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVtYWluaW5nSW5zZXJ0czogeyBbaWQ6IHN0cmluZ106IHN0cmluZ1tdfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByb3V0ZXM6IHN0cmluZ1tdKTogdm9pZCB7XG5cbiAgICAgICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKHJlbWFpbmluZ0luc2VydHMgfHwge30pO1xuICAgICAgICBsZXQgdG90YWxSZW1haW5pbmcgPSAwO1xuICAgICAgICBrZXlzLmZvckVhY2goa2V5ID0+IHtcbiAgICAgICAgICAgIHRvdGFsUmVtYWluaW5nICs9IHJlbWFpbmluZ0luc2VydHNba2V5XS5sZW5ndGg7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmICh0b3RhbFJlbWFpbmluZyA+IDApIHtcbiAgICAgICAgICAgIGxvZ2dlci5iYW5uZXIoXCJcIik7XG4gICAgICAgICAgICBsb2dnZXIuYmFubmVyKFwiLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXCIpO1xuICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoXCJXZSBjb3VsZG4ndCBmaW5kIGEgbG9jYXRpb24gdG8gaW5zZXJ0IHNvbWUgb2YgdGhlIHJvdXRlciBkYXRhLCBwbGVhc2UgaW5zZXJ0IHRoZSBmb2xsb3dpbmcgbWFudWFsbHk6XCIpO1xuICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoXCJcIik7XG4gICAgICAgICAgICBrZXlzLmZvckVhY2goa2V5ID0+IHtcbiAgICAgICAgICAgICAgICBpZiAocmVtYWluaW5nSW5zZXJ0c1trZXldLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmJhbm5lcihrZXkpO1xuICAgICAgICAgICAgICAgICAgICBsb2dnZXIuYmFubmVyKFwiXCIpO1xuICAgICAgICAgICAgICAgICAgICByZW1haW5pbmdJbnNlcnRzW2tleV0uZm9yRWFjaChpdGVtID0+IGxvZ2dlci5iYW5uZXIoYCAgICR7aXRlbS5yZXBsYWNlKC9cXG4vZywgXCJcXG4gICBcIil9YCkpO1xuICAgICAgICAgICAgICAgICAgICBsb2dnZXIuYmFubmVyKFwiXCIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgbG9nZ2VyLmJhbm5lcihcIi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVwiKTtcbiAgICAgICAgICAgIGxvZ2dlci5iYW5uZXIoXCJcIik7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocm91dGVzICYmIHJvdXRlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBsb2dnZXIuYmFubmVyKFwiT25jZSB5b3UgaGF2ZSBidWlsdCB0aGUgYXBwbGljYXRpb24geW91IHNob3VsZCBiZSBhYmxlIGFjY2VzcyB0aGUgbmV3IHBhZ2VzIGF0IHRoZSBmb2xsb3dpbmcgcm91dGVzOlwiKTtcbiAgICAgICAgICAgIGxvZ2dlci5iYW5uZXIoXCJcIik7XG4gICAgICAgICAgICByb3V0ZXMuZm9yRWFjaChyb3V0ZSA9PiBsb2dnZXIuYmFubmVyKGAgICAke3JvdXRlfWApKTtcbiAgICAgICAgICAgIGxvZ2dlci5iYW5uZXIoXCJcIik7XG4gICAgICAgIH1cbiAgICB9XG59XG4iXX0=
