"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * Pipeline step to generate scaffolding for angular application.
 */
const arrayHelper_1 = require("unitejs-framework/dist/helpers/arrayHelper");
const objectHelper_1 = require("unitejs-framework/dist/helpers/objectHelper");
const templateHelper_1 = require("../../helpers/templateHelper");
const sharedAppFramework_1 = require("../sharedAppFramework");
class Angular extends sharedAppFramework_1.SharedAppFramework {
    mainCondition(uniteConfiguration, engineVariables) {
        return super.condition(uniteConfiguration.applicationFramework, "Angular");
    }
    initialise(logger, fileSystem, uniteConfiguration, engineVariables, mainCondition) {
        const _super = name => super[name];
        return __awaiter(this, void 0, void 0, function* () {
            if (mainCondition) {
                if (_super("condition").call(this, uniteConfiguration.bundler, "RequireJS")) {
                    logger.error(`Angular does not currently support bundling with ${uniteConfiguration.bundler}`);
                    return 1;
                }
                arrayHelper_1.ArrayHelper.addRemove(uniteConfiguration.viewExtensions, "html", true);
            }
            return 0;
        });
    }
    configure(logger, fileSystem, uniteConfiguration, engineVariables, mainCondition) {
        const _super = name => super[name];
        return __awaiter(this, void 0, void 0, function* () {
            this.toggleDependencies(logger, uniteConfiguration, engineVariables, mainCondition);
            const usingGulp = _super("condition").call(this, uniteConfiguration.taskManager, "Gulp");
            if (mainCondition && usingGulp) {
                engineVariables.buildTranspileInclude.push("const inline = require(\"gulp-inline-ng2-template\");");
                engineVariables.buildTranspileInclude.push("const replace = require(\"gulp-replace\");");
                engineVariables.buildTranspilePreBuild.push("        .pipe(buildConfiguration.bundle ? inline({");
                engineVariables.buildTranspilePreBuild.push("                useRelativePaths: true,");
                engineVariables.buildTranspilePreBuild.push("                removeLineBreaks: true,");
                engineVariables.buildTranspilePreBuild.push("                customFilePath: (ext, inlinePath) => ext[0] === \".css\" ?");
                engineVariables.buildTranspilePreBuild.push("                    inlinePath.replace(`\${path.sep}src\${path.sep}`, `\${path.sep}dist\${path.sep}`) : inlinePath");
                engineVariables.buildTranspilePreBuild.push("        }) : gutil.noop())");
                const moduleIdRegEx = engineVariables.moduleId.replace(/\./g, "\\.")
                    .replace(/\(/g, "\\(")
                    .replace(/\)/g, "\\)");
                engineVariables.buildTranspilePreBuild.push(`        .pipe(buildConfiguration.bundle ? replace(/moduleId: ${moduleIdRegEx},/, "") : gutil.noop())`);
            }
            engineVariables.toggleDevDependency(["gulp-inline-ng2-template"], mainCondition && usingGulp);
            engineVariables.toggleDevDependency(["unitejs-protractor-plugin"], mainCondition && _super("condition").call(this, uniteConfiguration.e2eTestRunner, "Protractor"));
            engineVariables.toggleDevDependency(["unitejs-webdriver-plugin"], mainCondition && _super("condition").call(this, uniteConfiguration.e2eTestRunner, "WebdriverIO"));
            engineVariables.toggleDevDependency(["babel-plugin-transform-decorators-legacy", "babel-plugin-transform-class-properties"], mainCondition && _super("condition").call(this, uniteConfiguration.sourceLanguage, "JavaScript"));
            engineVariables.toggleDevDependency(["babel-eslint"], mainCondition && _super("condition").call(this, uniteConfiguration.linter, "ESLint"));
            engineVariables.toggleDevDependency(["@types/systemjs"], mainCondition && _super("condition").call(this, uniteConfiguration.sourceLanguage, "TypeScript"));
            const protractorConfiguration = engineVariables.getConfiguration("Protractor");
            if (protractorConfiguration) {
                const plugin = fileSystem.pathToWeb(fileSystem.pathFileRelative(engineVariables.wwwRootFolder, fileSystem.pathCombine(engineVariables.www.package, "unitejs-protractor-plugin")));
                arrayHelper_1.ArrayHelper.addRemove(protractorConfiguration.plugins, { path: plugin }, mainCondition, (object, item) => object.path === item.path);
            }
            const webdriverIoPlugins = engineVariables.getConfiguration("WebdriverIO.Plugins");
            if (webdriverIoPlugins) {
                arrayHelper_1.ArrayHelper.addRemove(webdriverIoPlugins, "unitejs-webdriver-plugin", mainCondition);
            }
            const babelConfiguration = engineVariables.getConfiguration("Babel");
            if (babelConfiguration) {
                arrayHelper_1.ArrayHelper.addRemove(babelConfiguration.plugins, "transform-decorators-legacy", mainCondition);
                arrayHelper_1.ArrayHelper.addRemove(babelConfiguration.plugins, "transform-class-properties", mainCondition);
            }
            const esLintConfiguration = engineVariables.getConfiguration("ESLint");
            if (esLintConfiguration) {
                objectHelper_1.ObjectHelper.addRemove(esLintConfiguration.globals, "__moduleName", true, mainCondition);
                objectHelper_1.ObjectHelper.addRemove(esLintConfiguration.globals, "module", true, mainCondition);
                objectHelper_1.ObjectHelper.addRemove(esLintConfiguration, "parser", "babel-eslint", mainCondition);
                objectHelper_1.ObjectHelper.addRemove(esLintConfiguration.rules, "no-unused-vars", 1, mainCondition);
            }
            const typeScriptConfiguration = engineVariables.getConfiguration("TypeScript");
            if (typeScriptConfiguration) {
                objectHelper_1.ObjectHelper.addRemove(typeScriptConfiguration.compilerOptions, "experimentalDecorators", true, mainCondition);
            }
            const javaScriptConfiguration = engineVariables.getConfiguration("JavaScript");
            if (javaScriptConfiguration) {
                objectHelper_1.ObjectHelper.addRemove(javaScriptConfiguration.compilerOptions, "experimentalDecorators", true, mainCondition);
            }
            const tsLintConfiguration = engineVariables.getConfiguration("TSLint");
            if (tsLintConfiguration) {
                objectHelper_1.ObjectHelper.addRemove(tsLintConfiguration.rules, "no-empty", { severity: "warning" }, mainCondition);
                objectHelper_1.ObjectHelper.addRemove(tsLintConfiguration.rules, "no-empty-interface", { severity: "warning" }, mainCondition);
                objectHelper_1.ObjectHelper.addRemove(tsLintConfiguration.rules, "interface-name", false, mainCondition);
                objectHelper_1.ObjectHelper.addRemove(tsLintConfiguration.rules, "variable-name", [true, "allow-leading-underscore"], mainCondition);
            }
            return 0;
        });
    }
    finalise(logger, fileSystem, uniteConfiguration, engineVariables, mainCondition) {
        const _super = name => super[name];
        return __awaiter(this, void 0, void 0, function* () {
            if (mainCondition) {
                const sourceExtension = _super("condition").call(this, uniteConfiguration.sourceLanguage, "TypeScript") ? ".ts" : ".js";
                let ret = yield this.generateAppSource(logger, fileSystem, uniteConfiguration, engineVariables, [
                    `app.component${sourceExtension}`,
                    `app.module${sourceExtension}`,
                    `child/child.component${sourceExtension}`,
                    `bootstrapper${sourceExtension}`
                ], false);
                if (ret === 0) {
                    ret = yield _super("generateAppSource").call(this, logger, fileSystem, uniteConfiguration, engineVariables, [`entryPoint${sourceExtension}`], true);
                }
                if (ret === 0) {
                    ret = yield _super("generateAppHtml").call(this, logger, fileSystem, uniteConfiguration, engineVariables, ["app.component.html", "child/child.component.html"]);
                }
                if (ret === 0) {
                    ret = yield _super("generateAppCss").call(this, logger, fileSystem, uniteConfiguration, engineVariables, ["app.component", "child/child.component"]);
                }
                if (ret === 0) {
                    ret = yield _super("generateE2eTest").call(this, logger, fileSystem, uniteConfiguration, engineVariables, [`app.spec${sourceExtension}`], true);
                }
                if (ret === 0) {
                    ret = yield this.generateUnitTest(logger, fileSystem, uniteConfiguration, engineVariables, [`bootstrapper.spec${sourceExtension}`], true);
                }
                if (ret === 0) {
                    ret = yield this.generateUnitTest(logger, fileSystem, uniteConfiguration, engineVariables, [`app.module.spec${sourceExtension}`], false);
                }
                if (ret === 0) {
                    ret = yield _super("generateCss").call(this, logger, fileSystem, uniteConfiguration, engineVariables);
                }
                return ret;
            }
            else {
                return 0;
            }
        });
    }
    toggleDependencies(logger, uniteConfiguration, engineVariables, mainCondition) {
        const packages = ["core", "common", "compiler", "platform-browser", "platform-browser-dynamic", "http", "router", "forms"];
        packages.forEach(pkg => {
            const testAdditions = {};
            if (pkg !== "forms") {
                testAdditions[`@angular/${pkg}/testing`] = `bundles/${pkg}-testing.umd.js`;
            }
            engineVariables.toggleClientPackage(`@angular/${pkg}`, {
                name: `@angular/${pkg}`,
                main: `bundles/${pkg}.umd.js`,
                mainMinified: `bundles/${pkg}.umd.min.js`,
                testingAdditions: testAdditions
            }, mainCondition);
        });
        engineVariables.toggleClientPackage("rxjs", {
            name: "rxjs",
            main: "*",
            mainLib: ["*.js",
                "add/**/*.js",
                "observable/**/*.js",
                "operator/**/*.js",
                "operators/**/*.js",
                "scheduler/**/*.js",
                "symbol/**/*.js",
                "testing/**/*.js",
                "util/**/*.js"
            ]
        }, mainCondition);
        engineVariables.toggleClientPackage("core-js", {
            name: "core-js",
            main: "client/shim.js",
            mainMinified: "client/shim.min.js",
            scriptIncludeMode: "both"
        }, mainCondition);
        engineVariables.toggleClientPackage("zone.js", {
            name: "zone.js",
            main: "dist/zone.js",
            mainMinified: "dist/zone.min.js",
            testingAdditions: {
                "long-stack-trace-zone": "dist/long-stack-trace-zone.js",
                proxy: "dist/proxy.js",
                "sync-test": "dist/sync-test.js",
                "runner-patch": super.condition(uniteConfiguration.unitTestFramework, "Jasmine") ? "dist/jasmine-patch.js" : "dist/mocha-patch.js",
                "async-test": "dist/async-test.js",
                "fake-async-test": "dist/fake-async-test.js"
            },
            scriptIncludeMode: "both"
        }, mainCondition);
        // main condition false to always remove, since ng5 no longer requires
        engineVariables.toggleClientPackage("reflect-metadata", {
            name: "reflect-metadata"
        }, false);
    }
    insertRoutes(logger, fileSystem, uniteConfiguration, engineVariables, routes) {
        const _super = name => super[name];
        return __awaiter(this, void 0, void 0, function* () {
            const sourceExtension = _super("condition").call(this, uniteConfiguration.sourceLanguage, "TypeScript") ? ".ts" : ".js";
            const bracketSpacing = _super("condition").call(this, uniteConfiguration.sourceLanguage, "TypeScript") ? " " : "";
            let routerItems = [];
            const importItems = [];
            let declarationItems = [];
            const routeItems = [];
            let navigationLinks = [];
            const keys = Object.keys(routes || {});
            for (let i = 0; i < keys.length; i++) {
                const route = routes[keys[i]];
                const words = templateHelper_1.TemplateHelper.generateWords(route.moduleType);
                const human = templateHelper_1.TemplateHelper.createHuman(words);
                importItems.push(`import {${bracketSpacing}${route.moduleType}${bracketSpacing}} from "${route.modulePath}";`);
                routerItems.push(`{${bracketSpacing}path: "${keys[i]}", component: ${route.moduleType}${bracketSpacing}}`);
                declarationItems.push(route.moduleType);
                routeItems.push(`/${keys[i]}`);
                navigationLinks.push(`<a routerLink="/${keys[i]}">${human}</a>`);
            }
            const remainingInserts = {};
            let ret = yield _super("insertContent").call(this, logger, fileSystem, engineVariables, `app.module${sourceExtension}`, (srcContent) => {
                let content = srcContent;
                const importsRemaining = _super("insertReplaceImports").call(this, content, importItems);
                content = importsRemaining.content;
                remainingInserts.imports = importsRemaining.remaining;
                const routerRegEx = /(const appRoutes = \[)([\s]*)([\s\S]*?)(\];)/;
                const routerResults = routerRegEx.exec(content);
                if (routerResults && routerResults.length > 3) {
                    const currentRouters = routerResults[3].trim();
                    routerItems = routerItems.filter(ri => currentRouters.replace(/\s/g, "")
                        .indexOf(ri.replace(/\s/g, "")) < 0);
                    if (routerItems.length > 0) {
                        const routerVar = routerResults[1];
                        const routerNewline = routerResults[2];
                        const routerEnd = routerResults[4];
                        let replaceRouters = `${routerNewline}${currentRouters},${routerNewline}`;
                        replaceRouters += `${routerItems.map(ri => ri.replace(/\n/g, routerNewline))
                            .join(`,${routerNewline}`)}\n`;
                        content = content.replace(routerResults[0], `${routerVar}${replaceRouters}${routerEnd}`);
                    }
                }
                else {
                    remainingInserts.router = routerItems;
                }
                const declarationRegEx = /(declarations: \[)(\s*)([\s\S]*?)(\s*\])/;
                const declarationResults = declarationRegEx.exec(content);
                if (declarationResults && declarationResults.length > 3) {
                    const currentDeclarations = declarationResults[3];
                    declarationItems = declarationItems.filter(di => currentDeclarations.indexOf(di) < 0);
                    if (declarationItems.length > 0) {
                        const declarationStart = declarationResults[1];
                        const declarationNewline = declarationResults[2];
                        const declarationEnd = declarationResults[4];
                        let replaceDeclarations = `${declarationNewline}${currentDeclarations},${declarationNewline}`;
                        replaceDeclarations += `${declarationItems.join(`,${declarationNewline}`)}`;
                        content = content.replace(declarationResults[0], `${declarationStart}${replaceDeclarations}${declarationEnd}`);
                    }
                }
                else {
                    remainingInserts.declarations = declarationItems;
                }
                return content;
            });
            if (ret === 0) {
                ret = yield _super("insertContent").call(this, logger, fileSystem, engineVariables, `app.component.html`, (srcContent) => {
                    let content = srcContent;
                    const navigationRegEx = /(<nav.*>)(\s*)([\s|\S]*?)((\s*)<\/nav>)/;
                    const navigationResults = navigationRegEx.exec(content);
                    if (navigationResults && navigationResults.length > 4) {
                        const currentLinks = navigationResults[3].trim();
                        navigationLinks = navigationLinks.filter(ri => currentLinks.replace(/\s/g, "")
                            .indexOf(ri.replace(/\s/g, "")) < 0);
                        if (navigationLinks.length > 0) {
                            const navigationStart = navigationResults[1];
                            const navigationNewline = navigationResults[2];
                            const nvaigationEnd = navigationResults[4];
                            let replaceRouters = `${navigationNewline}${currentLinks}${navigationNewline}`;
                            replaceRouters += `${navigationLinks.map(ri => ri.replace(/\n/g, navigationNewline))
                                .join(`${navigationNewline}`)}`;
                            content = content.replace(navigationResults[0], `${navigationStart}${replaceRouters}${nvaigationEnd}`);
                        }
                    }
                    else {
                        remainingInserts.navigationLinks = navigationLinks;
                    }
                    return content;
                });
            }
            if (ret === 0) {
                _super("insertCompletion").call(this, logger, remainingInserts, routeItems);
            }
            return ret;
        });
    }
}
exports.Angular = Angular;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9waXBlbGluZVN0ZXBzL2FwcGxpY2F0aW9uRnJhbWV3b3JrL2FuZ3VsYXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQUFBOztHQUVHO0FBQ0gsNEVBQXlFO0FBQ3pFLDhFQUEyRTtBQVkzRSxpRUFBOEQ7QUFFOUQsOERBQTJEO0FBRTNELE1BQWEsT0FBUSxTQUFRLHVDQUFrQjtJQUNwQyxhQUFhLENBQUMsa0JBQXNDLEVBQUUsZUFBZ0M7UUFDekYsT0FBTyxLQUFLLENBQUMsU0FBUyxDQUFDLGtCQUFrQixDQUFDLG9CQUFvQixFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQy9FLENBQUM7SUFFWSxVQUFVLENBQUMsTUFBZSxFQUFFLFVBQXVCLEVBQUUsa0JBQXNDLEVBQUUsZUFBZ0MsRUFBRSxhQUFzQjs7O1lBQzlKLElBQUksYUFBYSxFQUFFO2dCQUNmLElBQUksbUJBQWUsWUFBQyxrQkFBa0IsQ0FBQyxPQUFPLEVBQUUsV0FBVyxHQUFHO29CQUMxRCxNQUFNLENBQUMsS0FBSyxDQUFDLG9EQUFvRCxrQkFBa0IsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO29CQUMvRixPQUFPLENBQUMsQ0FBQztpQkFDWjtnQkFDRCx5QkFBVyxDQUFDLFNBQVMsQ0FBQyxrQkFBa0IsQ0FBQyxjQUFjLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDO2FBQzFFO1lBQ0QsT0FBTyxDQUFDLENBQUM7UUFDYixDQUFDO0tBQUE7SUFFWSxTQUFTLENBQUMsTUFBZSxFQUFFLFVBQXVCLEVBQUUsa0JBQXNDLEVBQUUsZUFBZ0MsRUFBRSxhQUFzQjs7O1lBQzdKLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLEVBQUUsa0JBQWtCLEVBQUUsZUFBZSxFQUFFLGFBQWEsQ0FBQyxDQUFDO1lBRXBGLE1BQU0sU0FBUyxHQUFHLG1CQUFlLFlBQUMsa0JBQWtCLENBQUMsV0FBVyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBQzFFLElBQUksYUFBYSxJ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RSxDQUFDOzRCQUNqRixPQUFPLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLENBQUMsRUFBRSxHQUFHLGVBQWUsR0FBRyxjQUFjLEdBQUcsYUFBYSxFQUFFLENBQUMsQ0FBQzt5QkFDMUc7cUJBQ0o7eUJBQU07d0JBQ0gsZ0JBQWdCLENBQUMsZUFBZSxHQUFHLGVBQWUsQ0FBQztxQkFDdEQ7b0JBRUQsT0FBTyxPQUFPLENBQUM7Z0JBQ25CLENBQUMsQ0FBQyxDQUFDO2FBQ1Y7WUFFRCxJQUFJLEdBQUcsS0FBSyxDQUFDLEVBQUU7Z0JBQ1gsMEJBQXNCLFlBQUMsTUFBTSxFQUFFLGdCQUFnQixFQUFFLFVBQVUsRUFBRTthQUNoRTtZQUVELE9BQU8sR0FBRyxDQUFDO1FBQ2YsQ0FBQztLQUFBO0NBQ0o7QUE1VUQsMEJBNFVDIiwiZmlsZSI6InBpcGVsaW5lU3RlcHMvYXBwbGljYXRpb25GcmFtZXdvcmsvYW5ndWxhci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogUGlwZWxpbmUgc3RlcCB0byBnZW5lcmF0ZSBzY2FmZm9sZGluZyBmb3IgYW5ndWxhciBhcHBsaWNhdGlvbi5cbiAqL1xuaW1wb3J0IHsgQXJyYXlIZWxwZXIgfSBmcm9tIFwidW5pdGVqcy1mcmFtZXdvcmsvZGlzdC9oZWxwZXJzL2FycmF5SGVscGVyXCI7XG5pbXBvcnQgeyBPYmplY3RIZWxwZXIgfSBmcm9tIFwidW5pdGVqcy1mcmFtZXdvcmsvZGlzdC9oZWxwZXJzL29iamVjdEhlbHBlclwiO1xuaW1wb3J0IHsgSUZpbGVTeXN0ZW0gfSBmcm9tIFwidW5pdGVqcy1mcmFtZXdvcmsvZGlzdC9pbnRlcmZhY2VzL0lGaWxlU3lzdGVtXCI7XG5pbXBvcnQgeyBJTG9nZ2VyIH0gZnJvbSBcInVuaXRlanMtZnJhbWV3b3JrL2Rpc3QvaW50ZXJmYWNlcy9JTG9nZ2VyXCI7XG5pbXBvcnQgeyBCYWJlbENvbmZpZ3VyYXRpb24gfSBmcm9tIFwiLi4vLi4vY29uZmlndXJhdGlvbi9tb2RlbHMvYmFiZWwvYmFiZWxDb25maWd1cmF0aW9uXCI7XG5pbXBvcnQgeyBFc0xpbnRDb25maWd1cmF0aW9uIH0gZnJvbSBcIi4uLy4uL2NvbmZpZ3VyYXRpb24vbW9kZWxzL2VzbGludC9lc0xpbnRDb25maWd1cmF0aW9uXCI7XG5pbXBvcnQgeyBQcm90cmFjdG9yQ29uZmlndXJhdGlvbiB9IGZyb20gXCIuLi8uLi9jb25maWd1cmF0aW9uL21vZGVscy9wcm90cmFjdG9yL3Byb3RyYWN0b3JDb25maWd1cmF0aW9uXCI7XG5pbXBvcnQgeyBUc0xpbnRDb25maWd1cmF0aW9uIH0gZnJvbSBcIi4uLy4uL2NvbmZpZ3VyYXRpb24vbW9kZWxzL3RzbGludC90c0xpbnRDb25maWd1cmF0aW9uXCI7XG5pbXBvcnQgeyBUeXBlU2NyaXB0Q29uZmlndXJhdGlvbiB9IGZyb20gXCIuLi8uLi9jb25maWd1cmF0aW9uL21vZGVscy90eXBlU2NyaXB0L3R5cGVTY3JpcHRDb25maWd1cmF0aW9uXCI7XG5pbXBvcnQgeyBVbml0ZUNvbmZpZ3VyYXRpb24gfSBmcm9tIFwiLi4vLi4vY29uZmlndXJhdGlvbi9tb2RlbHMvdW5pdGUvdW5pdGVDb25maWd1cmF0aW9uXCI7XG5pbXBvcnQgeyBVbml0ZVBhY2thZ2VSb3V0ZUNvbmZpZ3VyYXRpb24gfSBmcm9tIFwiLi4vLi4vY29uZmlndXJhdGlvbi9tb2RlbHMvdW5pdGVQYWNrYWdlcy91bml0ZVBhY2thZ2VSb3V0ZUNvbmZpZ3VyYXRpb25cIjtcbmltcG9ydCB7IEphdmFTY3JpcHRDb25maWd1cmF0aW9uIH0gZnJvbSBcIi4uLy4uL2NvbmZpZ3VyYXRpb24vbW9kZWxzL3ZzY29kZS9qYXZhU2NyaXB0Q29uZmlndXJhdGlvblwiO1xuaW1wb3J0IHsgRW5naW5lVmFyaWFibGVzIH0gZnJvbSBcIi4uLy4uL2VuZ2luZS9lbmdpbmVWYXJpYWJsZXNcIjtcbmltcG9ydCB7IFRlbXBsYXRlSGVscGVyIH0gZnJvbSBcIi4uLy4uL2hlbHBlcnMvdGVtcGxhdGVIZWxwZXJcIjtcbmltcG9ydCB7IElBcHBsaWNhdGlvbkZyYW1ld29yayB9IGZyb20gXCIuLi8uLi9pbnRlcmZhY2VzL0lBcHBsaWNhdGlvbkZyYW1ld29ya1wiO1xuaW1wb3J0IHsgU2hhcmVkQXBwRnJhbWV3b3JrIH0gZnJvbSBcIi4uL3NoYXJlZEFwcEZyYW1ld29ya1wiO1xuXG5leHBvcnQgY2xhc3MgQW5ndWxhciBleHRlbmRzIFNoYXJlZEFwcEZyYW1ld29yayBpbXBsZW1lbnRzIElBcHBsaWNhdGlvbkZyYW1ld29yayB7XG4gICAgcHVibGljIG1haW5Db25kaXRpb24odW5pdGVDb25maWd1cmF0aW9uOiBVbml0ZUNvbmZpZ3VyYXRpb24sIGVuZ2luZVZhcmlhYmxlczogRW5naW5lVmFyaWFibGVzKTogYm9vbGVhbiB8IHVuZGVmaW5lZCB7XG4gICAgICAgIHJldHVybiBzdXBlci5jb25kaXRpb24odW5pdGVDb25maWd1cmF0aW9uLmFwcGxpY2F0aW9uRnJhbWV3b3JrLCBcIkFuZ3VsYXJcIik7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGluaXRpYWxpc2UobG9nZ2VyOiBJTG9nZ2VyLCBmaWxlU3lzdGVtOiBJRmlsZVN5c3RlbSwgdW5pdGVDb25maWd1cmF0aW9uOiBVbml0ZUNvbmZpZ3VyYXRpb24sIGVuZ2luZVZhcmlhYmxlczogRW5naW5lVmFyaWFibGVzLCBtYWluQ29uZGl0aW9uOiBib29sZWFuKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICAgICAgaWYgKG1haW5Db25kaXRpb24pIHtcbiAgICAgICAgICAgIGlmIChzdXBlci5jb25kaXRpb24odW5pdGVDb25maWd1cmF0aW9uLmJ1bmRsZXIsIFwiUmVxdWlyZUpTXCIpKSB7XG4gICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGBBbmd1bGFyIGRvZXMgbm90IGN1cnJlbnRseSBzdXBwb3J0IGJ1bmRsaW5nIHdpdGggJHt1bml0ZUNvbmZpZ3VyYXRpb24uYnVuZGxlcn1gKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIEFycmF5SGVscGVyLmFkZFJlbW92ZSh1bml0ZUNvbmZpZ3VyYXRpb24udmlld0V4dGVuc2lvbnMsIFwiaHRtbFwiLCB0cnVlKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gMDtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgY29uZmlndXJlKGxvZ2dlcjogSUxvZ2dlciwgZmlsZVN5c3RlbTogSUZpbGVTeXN0ZW0sIHVuaXRlQ29uZmlndXJhdGlvbjogVW5pdGVDb25maWd1cmF0aW9uLCBlbmdpbmVWYXJpYWJsZXM6IEVuZ2luZVZhcmlhYmxlcywgbWFpbkNvbmRpdGlvbjogYm9vbGVhbik6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgICAgIHRoaXMudG9nZ2xlRGVwZW5kZW5jaWVzKGxvZ2dlciwgdW5pdGVDb25maWd1cmF0aW9uLCBlbmdpbmVWYXJpYWJsZXMsIG1haW5Db25kaXRpb24pO1xuXG4gICAgICAgIGNvbnN0IHVzaW5nR3VscCA9IHN1cGVyLmNvbmRpdGlvbih1bml0ZUNvbmZpZ3VyYXRpb24udGFza01hbmFnZXIsIFwiR3VscFwiKTtcbiAgICAgICAgaWYgKG1haW5Db25kaXRpb24gJiYgdXNpbmdHdWxwKSB7XG4gICAgICAgICAgICBlbmdpbmVWYXJpYWJsZXMuYnVpbGRUcmFuc3BpbGVJbmNsdWRlLnB1c2goXCJjb25zdCBpbmxpbmUgPSByZXF1aXJlKFxcXCJndWxwLWlubGluZS1uZzItdGVtcGxhdGVcXFwiKTtcIik7XG4gICAgICAgICAgICBlbmdpbmVWYXJpYWJsZXMuYnVpbGRUcmFuc3BpbGVJbmNsdWRlLnB1c2goXCJjb25zdCByZXBsYWNlID0gcmVxdWlyZShcXFwiZ3VscC1yZXBsYWNlXFxcIik7XCIpO1xuXG4gICAgICAgICAgICBlbmdpbmVWYXJpYWJsZXMuYnVpbGRUcmFuc3BpbGVQcmVCdWlsZC5wdXNoKFwiICAgICAgICAucGlwZShidWlsZENvbmZpZ3VyYXRpb24uYnVuZGxlID8gaW5saW5lKHtcIik7XG4gICAgICAgICAgICBlbmdpbmVWYXJpYWJsZXMuYnVpbGRUcmFuc3BpbGVQcmVCdWlsZC5wdXNoKFwiICAgICAgICAgICAgICAgIHVzZVJlbGF0aXZlUGF0aHM6IHRydWUsXCIpO1xuICAgICAgICAgICAgZW5naW5lVmFyaWFibGVzLmJ1aWxkVHJhbnNwaWxlUHJlQnVpbGQucHVzaChcIiAgICAgICAgICAgICAgICByZW1vdmVMaW5lQnJlYWtzOiB0cnVlLFwiKTtcbiAgICAgICAgICAgIGVuZ2luZVZhcmlhYmxlcy5idWlsZFRyYW5zcGlsZVByZUJ1aWxkLnB1c2goXCIgICAgICAgICAgICAgICAgY3VzdG9tRmlsZVBhdGg6IChleHQsIGlubGluZVBhdGgpID0+IGV4dFswXSA9PT0gXFxcIi5jc3NcXFwiID9cIik7XG4gICAgICAgICAgICBlbmdpbmVWYXJpYWJsZXMuYnVpbGRUcmFuc3BpbGVQcmVCdWlsZC5wdXNoKFwiICAgICAgICAgICAgICAgICAgICBpbmxpbmVQYXRoLnJlcGxhY2UoYFxcJHtwYXRoLnNlcH1zcmNcXCR7cGF0aC5zZXB9YCwgYFxcJHtwYXRoLnNlcH1kaXN0XFwke3BhdGguc2VwfWApIDogaW5saW5lUGF0aFwiKTtcbiAgICAgICAgICAgIGVuZ2luZVZhcmlhYmxlcy5idWlsZFRyYW5zcGlsZVByZUJ1aWxkLnB1c2goXCIgICAgICAgIH0pIDogZ3V0aWwubm9vcCgpKVwiKTtcblxuICAgICAgICAgICAgY29uc3QgbW9kdWxlSWRSZWdFeCA9IGVuZ2luZVZhcmlhYmxlcy5tb2R1bGVJZC5yZXBsYWNlKC9cXC4vZywgXCJcXFxcLlwiKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL1xcKC9nLCBcIlxcXFwoXCIpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvXFwpL2csIFwiXFxcXClcIik7XG5cbiAgICAgICAgICAgIGVuZ2luZVZhcmlhYmxlcy5idWlsZFRyYW5zcGlsZVByZUJ1aWxkLnB1c2goYCAgICAgICAgLnBpcGUoYnVpbGRDb25maWd1cmF0aW9uLmJ1bmRsZSA/IHJlcGxhY2UoL21vZHVsZUlkOiAke21vZHVsZUlkUmVnRXh9LC8sIFwiXCIpIDogZ3V0aWwubm9vcCgpKWApO1xuICAgICAgICB9XG5cbiAgICAgICAgZW5naW5lVmFyaWFibGVzLnRvZ2dsZURldkRlcGVuZGVuY3koW1wiZ3VscC1pbmxpbmUtbmcyLXRlbXBsYXRlXCJdLCBtYWluQ29uZGl0aW9uICYmIHVzaW5nR3VscCk7XG5cbiAgICAgICAgZW5naW5lVmFyaWFibGVzLnRvZ2dsZURldkRlcGVuZGVuY3koW1widW5pdGVqcy1wcm90cmFjdG9yLXBsdWdpblwiXSwgbWFpbkNvbmRpdGlvbiAmJiBzdXBlci5jb25kaXRpb24odW5pdGVDb25maWd1cmF0aW9uLmUyZVRlc3RSdW5uZXIsIFwiUHJvdHJhY3RvclwiKSk7XG4gICAgICAgIGVuZ2luZVZhcmlhYmxlcy50b2dnbGVEZXZEZXBlbmRlbmN5KFtcInVuaXRlanMtd2ViZHJpdmVyLXBsdWdpblwiXSwgbWFpbkNvbmRpdGlvbiAmJiBzdXBlci5jb25kaXRpb24odW5pdGVDb25maWd1cmF0aW9uLmUyZVRlc3RSdW5uZXIsIFwiV2ViZHJpdmVySU9cIikpO1xuXG4gICAgICAgIGVuZ2luZVZhcmlhYmxlcy50b2dnbGVEZXZEZXBlbmRlbmN5KFtcImJhYmVsLXBsdWdpbi10cmFuc2Zvcm0tZGVjb3JhdG9ycy1sZWdhY3lcIiwgXCJiYWJlbC1wbHVnaW4tdHJhbnNmb3JtLWNsYXNzLXByb3BlcnRpZXNcIl0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1haW5Db25kaXRpb24gJiYgc3VwZXIuY29uZGl0aW9uKHVuaXRlQ29uZmlndXJhdGlvbi5zb3VyY2VMYW5ndWFnZSwgXCJKYXZhU2NyaXB0XCIpKTtcbiAgICAgICAgZW5naW5lVmFyaWFibGVzLnRvZ2dsZURldkRlcGVuZGVuY3koW1wiYmFiZWwtZXNsaW50XCJdLCBtYWluQ29uZGl0aW9uICYmIHN1cGVyLmNvbmRpdGlvbih1bml0ZUNvbmZpZ3VyYXRpb24ubGludGVyLCBcIkVTTGludFwiKSk7XG4gICAgICAgIGVuZ2luZVZhcmlhYmxlcy50b2dnbGVEZXZEZXBlbmRlbmN5KFtcIkB0eXBlcy9zeXN0ZW1qc1wiXSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFpbkNvbmRpdGlvbiAmJiBzdXBlci5jb25kaXRpb24odW5pdGVDb25maWd1cmF0aW9uLnNvdXJjZUxhbmd1YWdlLCBcIlR5cGVTY3JpcHRcIikpO1xuXG4gICAgICAgIGNvbnN0IHByb3RyYWN0b3JDb25maWd1cmF0aW9uID0gZW5naW5lVmFyaWFibGVzLmdldENvbmZpZ3VyYXRpb248UHJvdHJhY3RvckNvbmZpZ3VyYXRpb24+KFwiUHJvdHJhY3RvclwiKTtcbiAgICAgICAgaWYgKHByb3RyYWN0b3JDb25maWd1cmF0aW9uKSB7XG4gICAgICAgICAgICBjb25zdCBwbHVnaW4gPSBmaWxlU3lzdGVtLnBhdGhUb1dlYihmaWxlU3lzdGVtLnBhdGhGaWxlUmVsYXRpdmUoZW5naW5lVmFyaWFibGVzLnd3d1Jvb3RGb2xkZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZVN5c3RlbS5wYXRoQ29tYmluZShlbmdpbmVWYXJpYWJsZXMud3d3LnBhY2thZ2UsIFwidW5pdGVqcy1wcm90cmFjdG9yLXBsdWdpblwiKSkpO1xuICAgICAgICAgICAgQXJyYXlIZWxwZXIuYWRkUmVtb3ZlKHByb3RyYWN0b3JDb25maWd1cmF0aW9uLnBsdWdpbnMsIHsgcGF0aDogcGx1Z2luIH0sIG1haW5Db25kaXRpb24sIChvYmplY3QsIGl0ZW0pID0+IG9iamVjdC5wYXRoID09PSBpdGVtLnBhdGgpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHdlYmRyaXZlcklvUGx1Z2lucyA9IGVuZ2luZVZhcmlhYmxlcy5nZXRDb25maWd1cmF0aW9uPHN0cmluZ1tdPihcIldlYmRyaXZlcklPLlBsdWdpbnNcIik7XG4gICAgICAgIGlmICh3ZWJkcml2ZXJJb1BsdWdpbnMpIHtcbiAgICAgICAgICAgIEFycmF5SGVscGVyLmFkZFJlbW92ZSh3ZWJkcml2ZXJJb1BsdWdpbnMsIFwidW5pdGVqcy13ZWJkcml2ZXItcGx1Z2luXCIsIG1haW5Db25kaXRpb24pO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgYmFiZWxDb25maWd1cmF0aW9uID0gZW5naW5lVmFyaWFibGVzLmdldENvbmZpZ3VyYXRpb248QmFiZWxDb25maWd1cmF0aW9uPihcIkJhYmVsXCIpO1xuICAgICAgICBpZiAoYmFiZWxDb25maWd1cmF0aW9uKSB7XG4gICAgICAgICAgICBBcnJheUhlbHBlci5hZGRSZW1vdmUoYmFiZWxDb25maWd1cmF0aW9uLnBsdWdpbnMsIFwidHJhbnNmb3JtLWRlY29yYXRvcnMtbGVnYWN5XCIsIG1haW5Db25kaXRpb24pO1xuICAgICAgICAgICAgQXJyYXlIZWxwZXIuYWRkUmVtb3ZlKGJhYmVsQ29uZmlndXJhdGlvbi5wbHVnaW5zLCBcInRyYW5zZm9ybS1jbGFzcy1wcm9wZXJ0aWVzXCIsIG1haW5Db25kaXRpb24pO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZXNMaW50Q29uZmlndXJhdGlvbiA9IGVuZ2luZVZhcmlhYmxlcy5nZXRDb25maWd1cmF0aW9uPEVzTGludENvbmZpZ3VyYXRpb24+KFwiRVNMaW50XCIpO1xuICAgICAgICBpZiAoZXNMaW50Q29uZmlndXJhdGlvbikge1xuICAgICAgICAgICAgT2JqZWN0SGVscGVyLmFkZFJlbW92ZShlc0xpbnRDb25maWd1cmF0aW9uLmdsb2JhbHMsIFwiX19tb2R1bGVOYW1lXCIsIHRydWUsIG1haW5Db25kaXRpb24pO1xuICAgICAgICAgICAgT2JqZWN0SGVscGVyLmFkZFJlbW92ZShlc0xpbnRDb25maWd1cmF0aW9uLmdsb2JhbHMsIFwibW9kdWxlXCIsIHRydWUsIG1haW5Db25kaXRpb24pO1xuICAgICAgICAgICAgT2JqZWN0SGVscGVyLmFkZFJlbW92ZShlc0xpbnRDb25maWd1cmF0aW9uLCBcInBhcnNlclwiLCBcImJhYmVsLWVzbGludFwiLCBtYWluQ29uZGl0aW9uKTtcbiAgICAgICAgICAgIE9iamVjdEhlbHBlci5hZGRSZW1vdmUoZXNMaW50Q29uZmlndXJhdGlvbi5ydWxlcywgXCJuby11bnVzZWQtdmFyc1wiLCAxLCBtYWluQ29uZGl0aW9uKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHR5cGVTY3JpcHRDb25maWd1cmF0aW9uID0gZW5naW5lVmFyaWFibGVzLmdldENvbmZpZ3VyYXRpb248VHlwZVNjcmlwdENvbmZpZ3VyYXRpb24+KFwiVHlwZVNjcmlwdFwiKTtcbiAgICAgICAgaWYgKHR5cGVTY3JpcHRDb25maWd1cmF0aW9uKSB7XG4gICAgICAgICAgICBPYmplY3RIZWxwZXIuYWRkUmVtb3ZlKHR5cGVTY3JpcHRDb25maWd1cmF0aW9uLmNvbXBpbGVyT3B0aW9ucywgXCJleHBlcmltZW50YWxEZWNvcmF0b3JzXCIsIHRydWUsIG1haW5Db25kaXRpb24pO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgamF2YVNjcmlwdENvbmZpZ3VyYXRpb24gPSBlbmdpbmVWYXJpYWJsZXMuZ2V0Q29uZmlndXJhdGlvbjxKYXZhU2NyaXB0Q29uZmlndXJhdGlvbj4oXCJKYXZhU2NyaXB0XCIpO1xuICAgICAgICBpZiAoamF2YVNjcmlwdENvbmZpZ3VyYXRpb24pIHtcbiAgICAgICAgICAgIE9iamVjdEhlbHBlci5hZGRSZW1vdmUoamF2YVNjcmlwdENvbmZpZ3VyYXRpb24uY29tcGlsZXJPcHRpb25zLCBcImV4cGVyaW1lbnRhbERlY29yYXRvcnNcIiwgdHJ1ZSwgbWFpbkNvbmRpdGlvbik7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCB0c0xpbnRDb25maWd1cmF0aW9uID0gZW5naW5lVmFyaWFibGVzLmdldENvbmZpZ3VyYXRpb248VHNMaW50Q29uZmlndXJhdGlvbj4oXCJUU0xpbnRcIik7XG4gICAgICAgIGlmICh0c0xpbnRDb25maWd1cmF0aW9uKSB7XG4gICAgICAgICAgICBPYmplY3RIZWxwZXIuYWRkUmVtb3ZlKHRzTGludENvbmZpZ3VyYXRpb24ucnVsZXMsIFwibm8tZW1wdHlcIiwgeyBzZXZlcml0eTogXCJ3YXJuaW5nXCIgfSwgbWFpbkNvbmRpdGlvbik7XG4gICAgICAgICAgICBPYmplY3RIZWxwZXIuYWRkUmVtb3ZlKHRzTGludENvbmZpZ3VyYXRpb24ucnVsZXMsIFwibm8tZW1wdHktaW50ZXJmYWNlXCIsIHsgc2V2ZXJpdHk6IFwid2FybmluZ1wiIH0sIG1haW5Db25kaXRpb24pO1xuICAgICAgICAgICAgT2JqZWN0SGVscGVyLmFkZFJlbW92ZSh0c0xpbnRDb25maWd1cmF0aW9uLnJ1bGVzLCBcImludGVyZmFjZS1uYW1lXCIsIGZhbHNlLCBtYWluQ29uZGl0aW9uKTtcbiAgICAgICAgICAgIE9iamVjdEhlbHBlci5hZGRSZW1vdmUodHNMaW50Q29uZmlndXJhdGlvbi5ydWxlcywgXCJ2YXJpYWJsZS1uYW1lXCIsIFt0cnVlLCBcImFsbG93LWxlYWRpbmctdW5kZXJzY29yZVwiXSwgbWFpbkNvbmRpdGlvbik7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gMDtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgZmluYWxpc2UobG9nZ2VyOiBJTG9nZ2VyLCBmaWxlU3lzdGVtOiBJRmlsZVN5c3RlbSwgdW5pdGVDb25maWd1cmF0aW9uOiBVbml0ZUNvbmZpZ3VyYXRpb24sIGVuZ2luZVZhcmlhYmxlczogRW5naW5lVmFyaWFibGVzLCBtYWluQ29uZGl0aW9uOiBib29sZWFuKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICAgICAgaWYgKG1haW5Db25kaXRpb24pIHtcbiAgICAgICAgICAgIGNvbnN0IHNvdXJjZUV4dGVuc2lvbiA9IHN1cGVyLmNvbmRpdGlvbih1bml0ZUNvbmZpZ3VyYXRpb24uc291cmNlTGFuZ3VhZ2UsIFwiVHlwZVNjcmlwdFwiKSA/IFwiLnRzXCIgOiBcIi5qc1wiO1xuXG4gICAgICAgICAgICBsZXQgcmV0ID0gYXdhaXQgdGhpcy5nZW5lcmF0ZUFwcFNvdXJjZShsb2dnZXIsIGZpbGVTeXN0ZW0sIHVuaXRlQ29uZmlndXJhdGlvbiwgZW5naW5lVmFyaWFibGVzLCBbXG4gICAgICAgICAgICAgICAgYGFwcC5jb21wb25lbnQke3NvdXJjZUV4dGVuc2lvbn1gLFxuICAgICAgICAgICAgICAgIGBhcHAubW9kdWxlJHtzb3VyY2VFeHRlbnNpb259YCxcbiAgICAgICAgICAgICAgICBgY2hpbGQvY2hpbGQuY29tcG9uZW50JHtzb3VyY2VFeHRlbnNpb259YCxcbiAgICAgICAgICAgICAgICBgYm9vdHN0cmFwcGVyJHtzb3VyY2VFeHRlbnNpb259YFxuICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhbHNlKTtcblxuICAgICAgICAgICAgaWYgKHJldCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIHJldCA9IGF3YWl0IHN1cGVyLmdlbmVyYXRlQXBwU291cmNlKGxvZ2dlciwgZmlsZVN5c3RlbSwgdW5pdGVDb25maWd1cmF0aW9uLCBlbmdpbmVWYXJpYWJsZXMsIFtgZW50cnlQb2ludCR7c291cmNlRXh0ZW5zaW9ufWBdLCB0cnVlKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHJldCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIHJldCA9IGF3YWl0IHN1cGVyLmdlbmVyYXRlQXBwSHRtbChsb2dnZXIsIGZpbGVTeXN0ZW0sIHVuaXRlQ29uZmlndXJhdGlvbiwgZW5naW5lVmFyaWFibGVzLCBbXCJhcHAuY29tcG9uZW50Lmh0bWxcIiwgXCJjaGlsZC9jaGlsZC5jb21wb25lbnQuaHRtbFwiXSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChyZXQgPT09IDApIHtcbiAgICAgICAgICAgICAgICByZXQgPSBhd2FpdCBzdXBlci5nZW5lcmF0ZUFwcENzcyhsb2dnZXIsIGZpbGVTeXN0ZW0sIHVuaXRlQ29uZmlndXJhdGlvbiwgZW5naW5lVmFyaWFibGVzLCBbXCJhcHAuY29tcG9uZW50XCIsIFwiY2hpbGQvY2hpbGQuY29tcG9uZW50XCJdKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHJldCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIHJldCA9IGF3YWl0IHN1cGVyLmdlbmVyYXRlRTJlVGVzdChsb2dnZXIsIGZpbGVTeXN0ZW0sIHVuaXRlQ29uZmlndXJhdGlvbiwgZW5naW5lVmFyaWFibGVzLCBbYGFwcC5zcGVjJHtzb3VyY2VFeHRlbnNpb259YF0sIHRydWUpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAocmV0ID09PSAwKSB7XG4gICAgICAgICAgICAgICAgcmV0ID0gYXdhaXQgdGhpcy5nZW5lcmF0ZVVuaXRUZXN0KGxvZ2dlciwgZmlsZVN5c3RlbSwgdW5pdGVDb25maWd1cmF0aW9uLCBlbmdpbmVWYXJpYWJsZXMsIFtgYm9vdHN0cmFwcGVyLnNwZWMke3NvdXJjZUV4dGVuc2lvbn1gXSwgdHJ1ZSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChyZXQgPT09IDApIHtcbiAgICAgICAgICAgICAgICByZXQgPSBhd2FpdCB0aGlzLmdlbmVyYXRlVW5pdFRlc3QobG9nZ2VyLCBmaWxlU3lzdGVtLCB1bml0ZUNvbmZpZ3VyYXRpb24sIGVuZ2luZVZhcmlhYmxlcywgW2BhcHAubW9kdWxlLnNwZWMke3NvdXJjZUV4dGVuc2lvbn1gXSwgZmFsc2UpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAocmV0ID09PSAwKSB7XG4gICAgICAgICAgICAgICAgcmV0ID0gYXdhaXQgc3VwZXIuZ2VuZXJhdGVDc3MobG9nZ2VyLCBmaWxlU3lzdGVtLCB1bml0ZUNvbmZpZ3VyYXRpb24sIGVuZ2luZVZhcmlhYmxlcyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiByZXQ7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gMDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyB0b2dnbGVEZXBlbmRlbmNpZXMobG9nZ2VyOiBJTG9nZ2VyLCB1bml0ZUNvbmZpZ3VyYXRpb246IFVuaXRlQ29uZmlndXJhdGlvbiwgZW5naW5lVmFyaWFibGVzOiBFbmdpbmVWYXJpYWJsZXMsIG1haW5Db25kaXRpb246IGJvb2xlYW4pOiB2b2lkIHtcbiAgICAgICAgY29uc3QgcGFja2FnZXMgPSBbXCJjb3JlXCIsIFwiY29tbW9uXCIsIFwiY29tcGlsZXJcIiwgXCJwbGF0Zm9ybS1icm93c2VyXCIsIFwicGxhdGZvcm0tYnJvd3Nlci1keW5hbWljXCIsIFwiaHR0cFwiLCBcInJvdXRlclwiLCBcImZvcm1zXCJdO1xuXG4gICAgICAgIHBhY2thZ2VzLmZvckVhY2gocGtnID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHRlc3RBZGRpdGlvbnM6IHsgW2lkOiBzdHJpbmddOiBzdHJpbmcgfSA9IHt9O1xuICAgICAgICAgICAgaWYgKHBrZyAhPT0gXCJmb3Jtc1wiKSB7XG4gICAgICAgICAgICAgICAgdGVzdEFkZGl0aW9uc1tgQGFuZ3VsYXIvJHtwa2d9L3Rlc3RpbmdgXSA9IGBidW5kbGVzLyR7cGtnfS10ZXN0aW5nLnVtZC5qc2A7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGVuZ2luZVZhcmlhYmxlcy50b2dnbGVDbGllbnRQYWNrYWdlKGBAYW5ndWxhci8ke3BrZ31gLCB7XG4gICAgICAgICAgICAgICAgbmFtZTogYEBhbmd1bGFyLyR7cGtnfWAsXG4gICAgICAgICAgICAgICAgbWFpbjogYGJ1bmRsZXMvJHtwa2d9LnVtZC5qc2AsXG4gICAgICAgICAgICAgICAgbWFpbk1pbmlmaWVkOiBgYnVuZGxlcy8ke3BrZ30udW1kLm1pbi5qc2AsXG4gICAgICAgICAgICAgICAgdGVzdGluZ0FkZGl0aW9uczogdGVzdEFkZGl0aW9uc1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1haW5Db25kaXRpb24pO1xuICAgICAgICB9KTtcblxuICAgICAgICBlbmdpbmVWYXJpYWJsZXMudG9nZ2xlQ2xpZW50UGFja2FnZShcInJ4anNcIiwge1xuICAgICAgICAgICAgbmFtZTogXCJyeGpzXCIsXG4gICAgICAgICAgICBtYWluOiBcIipcIixcbiAgICAgICAgICAgIG1haW5MaWI6IFtcIiouanNcIixcbiAgICAgICAgICAgICAgICBcImFkZC8qKi8qLmpzXCIsXG4gICAgICAgICAgICAgICAgXCJvYnNlcnZhYmxlLyoqLyouanNcIixcbiAgICAgICAgICAgICAgICBcIm9wZXJhdG9yLyoqLyouanNcIixcbiAgICAgICAgICAgICAgICBcIm9wZXJhdG9ycy8qKi8qLmpzXCIsXG4gICAgICAgICAgICAgICAgXCJzY2hlZHVsZXIvKiovKi5qc1wiLFxuICAgICAgICAgICAgICAgIFwic3ltYm9sLyoqLyouanNcIixcbiAgICAgICAgICAgICAgICBcInRlc3RpbmcvKiovKi5qc1wiLFxuICAgICAgICAgICAgICAgIFwidXRpbC8qKi8qLmpzXCJcbiAgICAgICAgICAgIF1cbiAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFpbkNvbmRpdGlvbik7XG5cbiAgICAgICAgZW5naW5lVmFyaWFibGVzLnRvZ2dsZUNsaWVudFBhY2thZ2UoXCJjb3JlLWpzXCIsIHtcbiAgICAgICAgICAgIG5hbWU6IFwiY29yZS1qc1wiLFxuICAgICAgICAgICAgbWFpbjogXCJjbGllbnQvc2hpbS5qc1wiLFxuICAgICAgICAgICAgbWFpbk1pbmlmaWVkOiBcImNsaWVudC9zaGltLm1pbi5qc1wiLFxuICAgICAgICAgICAgc2NyaXB0SW5jbHVkZU1vZGU6IFwiYm90aFwiXG4gICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1haW5Db25kaXRpb24pO1xuXG4gICAgICAgIGVuZ2luZVZhcmlhYmxlcy50b2dnbGVDbGllbnRQYWNrYWdlKFwiem9uZS5qc1wiLCB7XG4gICAgICAgICAgICBuYW1lOiBcInpvbmUuanNcIixcbiAgICAgICAgICAgIG1haW46IFwiZGlzdC96b25lLmpzXCIsXG4gICAgICAgICAgICBtYWluTWluaWZpZWQ6IFwiZGlzdC96b25lLm1pbi5qc1wiLFxuICAgICAgICAgICAgdGVzdGluZ0FkZGl0aW9uczoge1xuICAgICAgICAgICAgICAgIFwibG9uZy1zdGFjay10cmFjZS16b25lXCI6IFwiZGlzdC9sb25nLXN0YWNrLXRyYWNlLXpvbmUuanNcIixcbiAgICAgICAgICAgICAgICBwcm94eTogXCJkaXN0L3Byb3h5LmpzXCIsXG4gICAgICAgICAgICAgICAgXCJzeW5jLXRlc3RcIjogXCJkaXN0L3N5bmMtdGVzdC5qc1wiLFxuICAgICAgICAgICAgICAgIFwicnVubmVyLXBhdGNoXCI6IHN1cGVyLmNvbmRpdGlvbih1bml0ZUNvbmZpZ3VyYXRpb24udW5pdFRlc3RGcmFtZXdvcmssIFwiSmFzbWluZVwiKSA/IFwiZGlzdC9qYXNtaW5lLXBhdGNoLmpzXCIgOiBcImRpc3QvbW9jaGEtcGF0Y2guanNcIixcbiAgICAgICAgICAgICAgICBcImFzeW5jLXRlc3RcIjogXCJkaXN0L2FzeW5jLXRlc3QuanNcIixcbiAgICAgICAgICAgICAgICBcImZha2UtYXN5bmMtdGVzdFwiOiBcImRpc3QvZmFrZS1hc3luYy10ZXN0LmpzXCJcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzY3JpcHRJbmNsdWRlTW9kZTogXCJib3RoXCJcbiAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFpbkNvbmRpdGlvbik7XG5cbiAgICAgICAgLy8gbWFpbiBjb25kaXRpb24gZmFsc2UgdG8gYWx3YXlzIHJlbW92ZSwgc2luY2Ugbmc1IG5vIGxvbmdlciByZXF1aXJlc1xuICAgICAgICBlbmdpbmVWYXJpYWJsZXMudG9nZ2xlQ2xpZW50UGFja2FnZShcInJlZmxlY3QtbWV0YWRhdGFcIiwge1xuICAgICAgICAgICAgbmFtZTogXCJyZWZsZWN0LW1ldGFkYXRhXCJcbiAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFsc2UpO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBpbnNlcnRSb3V0ZXMobG9nZ2VyOiBJTG9nZ2VyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZVN5c3RlbTogSUZpbGVTeXN0ZW0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1bml0ZUNvbmZpZ3VyYXRpb246IFVuaXRlQ29uZmlndXJhdGlvbixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZVZhcmlhYmxlczogRW5naW5lVmFyaWFibGVzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcm91dGVzOiB7IFtpZDogc3RyaW5nXTogVW5pdGVQYWNrYWdlUm91dGVDb25maWd1cmF0aW9uIH0pOiBQcm9taXNlPG51bWJlcj4ge1xuICAgICAgICBjb25zdCBzb3VyY2VFeHRlbnNpb24gPSBzdXBlci5jb25kaXRpb24odW5pdGVDb25maWd1cmF0aW9uLnNvdXJjZUxhbmd1YWdlLCBcIlR5cGVTY3JpcHRcIikgPyBcIi50c1wiIDogXCIuanNcIjtcbiAgICAgICAgY29uc3QgYnJhY2tldFNwYWNpbmcgPSBzdXBlci5jb25kaXRpb24odW5pdGVDb25maWd1cmF0aW9uLnNvdXJjZUxhbmd1YWdlLCBcIlR5cGVTY3JpcHRcIikgPyBcIiBcIiA6IFwiXCI7XG5cbiAgICAgICAgbGV0IHJvdXRlckl0ZW1zOiBzdHJpbmdbXSA9IFtdO1xuICAgICAgICBjb25zdCBpbXBvcnRJdGVtczogc3RyaW5nW10gPSBbXTtcbiAgICAgICAgbGV0IGRlY2xhcmF0aW9uSXRlbXM6IHN0cmluZ1tdID0gW107XG4gICAgICAgIGNvbnN0IHJvdXRlSXRlbXM6IHN0cmluZ1tdID0gW107XG4gICAgICAgIGxldCBuYXZpZ2F0aW9uTGlua3M6IHN0cmluZ1tdID0gW107XG5cbiAgICAgICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKHJvdXRlcyB8fCB7fSk7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgY29uc3Qgcm91dGUgPSByb3V0ZXNba2V5c1tpXV07XG5cbiAgICAgICAgICAgIGNvbnN0IHdvcmRzID0gVGVtcGxhdGVIZWxwZXIuZ2VuZXJhdGVXb3Jkcyhyb3V0ZS5tb2R1bGVUeXBlKTtcbiAgICAgICAgICAgIGNvbnN0IGh1bWFuID0gVGVtcGxhdGVIZWxwZXIuY3JlYXRlSHVtYW4od29yZHMpO1xuXG4gICAgICAgICAgICBpbXBvcnRJdGVtcy5wdXNoKGBpbXBvcnQgeyR7YnJhY2tldFNwYWNpbmd9JHtyb3V0ZS5tb2R1bGVUeXBlfSR7YnJhY2tldFNwYWNpbmd9fSBmcm9tIFwiJHtyb3V0ZS5tb2R1bGVQYXRofVwiO2ApO1xuICAgICAgICAgICAgcm91dGVySXRlbXMucHVzaChgeyR7YnJhY2tldFNwYWNpbmd9cGF0aDogXCIke2tleXNbaV19XCIsIGNvbXBvbmVudDogJHtyb3V0ZS5tb2R1bGVUeXBlfSR7YnJhY2tldFNwYWNpbmd9fWApO1xuICAgICAgICAgICAgZGVjbGFyYXRpb25JdGVtcy5wdXNoKHJvdXRlLm1vZHVsZVR5cGUpO1xuICAgICAgICAgICAgcm91dGVJdGVtcy5wdXNoKGAvJHtrZXlzW2ldfWApO1xuICAgICAgICAgICAgbmF2aWdhdGlvbkxpbmtzLnB1c2goYDxhIHJvdXRlckxpbms9XCIvJHtrZXlzW2ldfVwiPiR7aHVtYW59PC9hPmApO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcmVtYWluaW5nSW5zZXJ0czogeyBbaWQ6IHN0cmluZ106IHN0cmluZ1tdIH0gPSB7fTtcblxuICAgICAgICBsZXQgcmV0ID0gYXdhaXQgc3VwZXIuaW5zZXJ0Q29udGVudChsb2dnZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVTeXN0ZW0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZ2luZVZhcmlhYmxlcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYGFwcC5tb2R1bGUke3NvdXJjZUV4dGVuc2lvbn1gLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoc3JjQ29udGVudCkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBjb250ZW50ID0gc3JjQ29udGVudDtcblxuICAgICAgICAgICAgICAgIGNvbnN0IGltcG9ydHNSZW1haW5pbmcgPSBzdXBlci5pbnNlcnRSZXBsYWNlSW1wb3J0cyhjb250ZW50LCBpbXBvcnRJdGVtcyk7XG4gICAgICAgICAgICAgICAgY29udGVudCA9IGltcG9ydHNSZW1haW5pbmcuY29udGVudDtcbiAgICAgICAgICAgICAgICByZW1haW5pbmdJbnNlcnRzLmltcG9ydHMgPSBpbXBvcnRzUmVtYWluaW5nLnJlbWFpbmluZztcblxuICAgICAgICAgICAgICAgIGNvbnN0IHJvdXRlclJlZ0V4ID0gLyhjb25zdCBhcHBSb3V0ZXMgPSBcXFspKFtcXHNdKikoW1xcc1xcU10qPykoXFxdOykvO1xuICAgICAgICAgICAgICAgIGNvbnN0IHJvdXRlclJlc3VsdHMgPSByb3V0ZXJSZWdFeC5leGVjKGNvbnRlbnQpO1xuICAgICAgICAgICAgICAgIGlmIChyb3V0ZXJSZXN1bHRzICYmIHJvdXRlclJlc3VsdHMubGVuZ3RoID4gMykge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW50Um91dGVycyA9IHJvdXRlclJlc3VsdHNbM10udHJpbSgpO1xuXG4gICAgICAgICAgICAgICAgICAgIHJvdXRlckl0ZW1zID0gcm91dGVySXRlbXMuZmlsdGVyKHJpID0+IGN1cnJlbnRSb3V0ZXJzLnJlcGxhY2UoL1xccy9nLCBcIlwiKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5pbmRleE9mKHJpLnJlcGxhY2UoL1xccy9nLCBcIlwiKSkgPCAwKTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAocm91dGVySXRlbXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgcm91dGVyVmFyID0gcm91dGVyUmVzdWx0c1sxXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJvdXRlck5ld2xpbmUgPSByb3V0ZXJSZXN1bHRzWzJdO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgcm91dGVyRW5kID0gcm91dGVyUmVzdWx0c1s0XTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHJlcGxhY2VSb3V0ZXJzID0gYCR7cm91dGVyTmV3bGluZX0ke2N1cnJlbnRSb3V0ZXJzfSwke3JvdXRlck5ld2xpbmV9YDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxhY2VSb3V0ZXJzICs9IGAke3JvdXRlckl0ZW1zLm1hcChyaSA9PiByaS5yZXBsYWNlKC9cXG4vZywgcm91dGVyTmV3bGluZSkpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuam9pbihgLCR7cm91dGVyTmV3bGluZX1gKX1cXG5gO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29udGVudCA9IGNvbnRlbnQucmVwbGFjZShyb3V0ZXJSZXN1bHRzWzBdLCBgJHtyb3V0ZXJWYXJ9JHtyZXBsYWNlUm91dGVyc30ke3JvdXRlckVuZH1gKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJlbWFpbmluZ0luc2VydHMucm91dGVyID0gcm91dGVySXRlbXM7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgY29uc3QgZGVjbGFyYXRpb25SZWdFeCA9IC8oZGVjbGFyYXRpb25zOiBcXFspKFxccyopKFtcXHNcXFNdKj8pKFxccypcXF0pLztcblxuICAgICAgICAgICAgICAgIGNvbnN0IGRlY2xhcmF0aW9uUmVzdWx0cyA9IGRlY2xhcmF0aW9uUmVnRXguZXhlYyhjb250ZW50KTtcbiAgICAgICAgICAgICAgICBpZiAoZGVjbGFyYXRpb25SZXN1bHRzICYmIGRlY2xhcmF0aW9uUmVzdWx0cy5sZW5ndGggPiAzKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnREZWNsYXJhdGlvbnMgPSBkZWNsYXJhdGlvblJlc3VsdHNbM107XG5cbiAgICAgICAgICAgICAgICAgICAgZGVjbGFyYXRpb25JdGVtcyA9IGRlY2xhcmF0aW9uSXRlbXMuZmlsdGVyKGRpID0+IGN1cnJlbnREZWNsYXJhdGlvbnMuaW5kZXhPZihkaSkgPCAwKTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoZGVjbGFyYXRpb25JdGVtcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkZWNsYXJhdGlvblN0YXJ0ID0gZGVjbGFyYXRpb25SZXN1bHRzWzFdO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGVjbGFyYXRpb25OZXdsaW5lID0gZGVjbGFyYXRpb25SZXN1bHRzWzJdO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGVjbGFyYXRpb25FbmQgPSBkZWNsYXJhdGlvblJlc3VsdHNbNF07XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgcmVwbGFjZURlY2xhcmF0aW9ucyA9IGAke2RlY2xhcmF0aW9uTmV3bGluZX0ke2N1cnJlbnREZWNsYXJhdGlvbnN9LCR7ZGVjbGFyYXRpb25OZXdsaW5lfWA7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXBsYWNlRGVjbGFyYXRpb25zICs9IGAke2RlY2xhcmF0aW9uSXRlbXMuam9pbihgLCR7ZGVjbGFyYXRpb25OZXdsaW5lfWApfWA7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50ID0gY29udGVudC5yZXBsYWNlKGRlY2xhcmF0aW9uUmVzdWx0c1swXSwgYCR7ZGVjbGFyYXRpb25TdGFydH0ke3JlcGxhY2VEZWNsYXJhdGlvbnN9JHtkZWNsYXJhdGlvbkVuZH1gKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJlbWFpbmluZ0luc2VydHMuZGVjbGFyYXRpb25zID0gZGVjbGFyYXRpb25JdGVtcztcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gY29udGVudDtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIGlmIChyZXQgPT09IDApIHtcbiAgICAgICAgICAgIHJldCA9IGF3YWl0IHN1cGVyLmluc2VydENvbnRlbnQobG9nZ2VyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlU3lzdGVtLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmdpbmVWYXJpYWJsZXMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGBhcHAuY29tcG9uZW50Lmh0bWxgLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoc3JjQ29udGVudCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBsZXQgY29udGVudCA9IHNyY0NvbnRlbnQ7XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbmF2aWdhdGlvblJlZ0V4ID0gLyg8bmF2Lio+KShcXHMqKShbXFxzfFxcU10qPykoKFxccyopPFxcL25hdj4pLztcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbmF2aWdhdGlvblJlc3VsdHMgPSBuYXZpZ2F0aW9uUmVnRXguZXhlYyhjb250ZW50KTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG5hdmlnYXRpb25SZXN1bHRzICYmIG5hdmlnYXRpb25SZXN1bHRzLmxlbmd0aCA+IDQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRMaW5rcyA9IG5hdmlnYXRpb25SZXN1bHRzWzNdLnRyaW0oKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgbmF2aWdhdGlvbkxpbmtzID0gbmF2aWdhdGlvbkxpbmtzLmZpbHRlcihyaSA9PiBjdXJyZW50TGlua3MucmVwbGFjZSgvXFxzL2csIFwiXCIpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5pbmRleE9mKHJpLnJlcGxhY2UoL1xccy9nLCBcIlwiKSkgPCAwKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5hdmlnYXRpb25MaW5rcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbmF2aWdhdGlvblN0YXJ0ID0gbmF2aWdhdGlvblJlc3VsdHNbMV07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbmF2aWdhdGlvbk5ld2xpbmUgPSBuYXZpZ2F0aW9uUmVzdWx0c1syXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBudmFpZ2F0aW9uRW5kID0gbmF2aWdhdGlvblJlc3VsdHNbNF07XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgcmVwbGFjZVJvdXRlcnMgPSBgJHtuYXZpZ2F0aW9uTmV3bGluZX0ke2N1cnJlbnRMaW5rc30ke25hdmlnYXRpb25OZXdsaW5lfWA7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZVJvdXRlcnMgKz0gYCR7bmF2aWdhdGlvbkxpbmtzLm1hcChyaSA9PiByaS5yZXBsYWNlKC9cXG4vZywgbmF2aWdhdGlvbk5ld2xpbmUpKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuam9pbihgJHtuYXZpZ2F0aW9uTmV3bGluZX1gKX1gO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRlbnQgPSBjb250ZW50LnJlcGxhY2UobmF2aWdhdGlvblJlc3VsdHNbMF0sIGAke25hdmlnYXRpb25TdGFydH0ke3JlcGxhY2VSb3V0ZXJzfSR7bnZhaWdhdGlvbkVuZH1gKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlbWFpbmluZ0luc2VydHMubmF2aWdhdGlvbkxpbmtzID0gbmF2aWdhdGlvbkxpbmtzO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRlbnQ7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocmV0ID09PSAwKSB7XG4gICAgICAgICAgICBzdXBlci5pbnNlcnRDb21wbGV0aW9uKGxvZ2dlciwgcmVtYWluaW5nSW5zZXJ0cywgcm91dGVJdGVtcyk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmV0O1xuICAgIH1cbn1cbiJdfQ==
